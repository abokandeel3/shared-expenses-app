document.addEventListener("DOMContentLoaded",()=>{const e={expenses:[],expenseTypes:[],budgets:[],recurringExpenses:[],editMode:!1,currentEditId:null,currentPage:1,filters:{search:"",type:"all",startDate:"",endDate:""}};let t,n=!1,r=!1;const o=10,s=document.getElementById("expenseForm"),a=document.getElementById("expenseType"),i=document.getElementById("expenseFieldsContainer"),d=document.getElementById("totalLabel"),l=document.getElementById("expenseTableBody"),c=document.getElementById("totals"),u=document.querySelector(".you-paid"),p=document.querySelector(".partner-paid"),m=document.querySelector(".difference-amount"),g=document.querySelector(".total-paid-summary"),y=document.getElementById("resetBtn"),f=document.getElementById("date"),b=document.getElementById("exportBtn"),v=s.querySelector('button[type="submit"]'),x=document.getElementById("cancelEditBtn"),h=document.getElementById("searchInput"),E=document.getElementById("typeFilter"),I=document.getElementById("startDateFilter"),w=document.getElementById("endDateFilter"),T=document.getElementById("resetFiltersBtn"),S=document.getElementById("importBtn"),$=document.getElementById("importFile"),B=document.getElementById("prevPageBtn"),D=document.getElementById("nextPageBtn"),C=document.getElementById("pageInfo"),L=document.getElementById("budgetsListContainer"),k=document.getElementById("clearAllBudgetsBtn"),M=document.getElementById("exportBudgetsBtn"),F=document.getElementById("importBudgetsBtn"),j=document.getElementById("importBudgetsFile"),N=document.getElementById("splitMethodSelect"),q=document.getElementById("splitOptionsContainer"),O=document.getElementById("percentageInputs"),P=document.getElementById("yourPercentage"),A=document.getElementById("partnerPercentage"),H=document.getElementById("fixedInputs"),_=document.getElementById("yourFixedShare"),U=document.getElementById("partnerFixedShare"),W=document.getElementById("isRecurring"),R=document.getElementById("recurringOptions"),Y=document.getElementById("recurringFrequency");function J(e){const t={id:"",title:"Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø©",bodyContent:"<p>Ù…Ø­ØªÙˆÙ‰ Ø§ÙØªØ±Ø§Ø¶ÙŠ.</p>",footerContent:"",maxWidth:"700px",...e},n=document.createElement("div");n.id=t.id,n.className="modal-overlay",n.style.display="none";const r=t.id+"-title",o=`\n            <div class="modal-content" style="max-width: ${t.maxWidth};" role="dialog" aria-modal="true" aria-labelledby="${r}">\n                <div class="modal-header">\n                    <h3 id="${r}">${t.title}</h3>\n                    <button class="modal-close-btn" aria-label="Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©">&times;</button>\n                </div>\n                <div class="modal-body">\n                    ${t.bodyContent}\n                </div>\n                ${t.footerContent?`<div class="modal-footer" ${t.footerId?`id="${t.footerId}"`:""}>${t.footerContent}</div>`:""}\n            </div>\n        `;n.innerHTML=o,document.body.appendChild(n);const s=n.querySelector(".modal-close-btn"),a=n.querySelector(".modal-content");let i;const d=e=>{if("Tab"!==e.key)return;const t=Array.from(a.querySelectorAll("button, [href], input, select, textarea")),n=t[0],r=t[t.length-1];e.shiftKey&&document.activeElement===n?(r.focus(),e.preventDefault()):e.shiftKey||document.activeElement!==r||(n.focus(),e.preventDefault())},l=()=>{n.style.display="none",n.removeEventListener("keydown",d),i&&i.focus()};return s.addEventListener("click",l),n.addEventListener("click",e=>{e.target===n&&l()}),{id:t.id,element:n,open:e=>{i=e||document.activeElement,n.style.display="flex";const t=a.querySelector("button, [href], input, select, textarea");t&&t.focus(),n.addEventListener("keydown",d)},close:l}}const z=document.getElementById("customizeTypesBtn"),V=J({id:"customizeModal",title:"ØªØ®ØµÙŠØµ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª",bodyContent:'<div id="customizeModalBody"></div>',footerContent:'<button id="addNewTypeBtn" class="btn btn-add">Ø¥Ø¶Ø§ÙØ© Ù†ÙˆØ¹ Ø¬Ø¯ÙŠØ¯</button>'}),K=V.element.querySelector("#customizeModalBody"),Q=V.element.querySelector("#addNewTypeBtn"),G=document.getElementById("manageBudgetsBtn"),X=J({id:"manageBudgetsModal",title:"âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª",footerId:"budgetsModalFooter",bodyContent:'<div id="budgetsModalBody"></div>',footerContent:'\n            <button id="saveBudgetsBtn" class="btn btn-export">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>\n            <button id="addNewBudgetBtn" class="btn btn-add">+ Ø¥Ø¶Ø§ÙØ© Ù…ÙŠØ²Ø§Ù†ÙŠØ©</button>\n        '}),Z=X.element.querySelector("#budgetsModalBody"),ee=X.element.querySelector("#saveBudgetsBtn"),te=X.element.querySelector("#addNewBudgetBtn"),ne=document.getElementById("manageRecurringBtn"),re=J({id:"manageRecurringModal",title:"ğŸ”„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©",bodyContent:'\n            <details class="collapsible-info">\n                <summary class="collapsible-title">Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©ØŸ (Ø§Ø¶ØºØ· Ù„Ù„Ø´Ø±Ø­)</summary>\n                <div class="collapsible-content">\n                    <p>Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© ØªØ³Ù…Ø­ Ù„Ùƒ Ø¨Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© (Ù…Ø«Ù„ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø£Ùˆ Ø§Ù„ÙÙˆØ§ØªÙŠØ±) Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·. Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨ØªØ³Ø¬ÙŠÙ„Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù†ÙŠØ§Ø¨Ø© Ø¹Ù†Ùƒ ÙƒÙ„Ù…Ø§ Ø­Ø§Ù† ÙˆÙ‚ØªÙ‡Ø§.</p>\n                    <p><b>Ù…Ø§Ø°Ø§ Ø³ÙŠØ­Ø¯Ø«ØŸ</b> Ø¹Ù†Ø¯Ù…Ø§ ÙŠØ­ÙŠÙ† Ù…ÙˆØ¹Ø¯ Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ù…ØµØ±ÙˆÙ Ù…ØªÙƒØ±Ø± ÙˆØªÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŒ Ø³ØªØ¸Ù‡Ø± Ù„Ùƒ Ø±Ø³Ø§Ù„Ø© ØªÙ†Ø¨ÙŠÙ‡ Ø®Ø¶Ø±Ø§Ø¡ØŒ ÙˆØ³ØªØ¬Ø¯ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù‚Ø¯ Ø£Ø¶ÙŠÙ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø¨Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡ Ø¨Ù†Ø¬Ù…Ø© â­.</p>\n                </div>\n            </details>\n            <hr class="modal-divider">\n            <div id="recurringListContainer"></div>\n        '}),oe=J({id:"deleteConfirmModal",title:"ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù",maxWidth:"500px",bodyContent:"<p>Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙ ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§. Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø£Ù† ØªÙØ¹Ù„ØŸ</p>",footerContent:'\n            <div style="display: flex; justify-content: center; gap: 16px; width: 100%;">\n                <button id="confirmDeleteOnceBtn" class="btn btn-warning">Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø© ÙÙ‚Ø·</button>\n                <button id="confirmDeleteAllBtn" class="btn btn-reset">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙƒØ±Ø§Ø± Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§</button>\n            </div>\n        '}),se=oe.element.querySelector("#confirmDeleteOnceBtn"),ae=oe.element.querySelector("#confirmDeleteAllBtn"),ie=J({id:"clearAllConfirmModal",title:"ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ø´Ø§Ù…Ù„",maxWidth:"550px",bodyContent:'\n            <p>Ø£Ù†Øª Ø¹Ù„Ù‰ ÙˆØ´Ùƒ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„.</p>\n            <p class="description" style="margin-top: 10px;">Ù‡Ù„ ØªØ±ÙŠØ¯ Ø£ÙŠØ¶Ù‹Ø§ Ø­Ø°Ù <b>Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©</b> ÙˆØ¬Ù…ÙŠØ¹ <b>Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª</b> Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©ØŸ <br>Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø³ÙŠØ­Ø°Ù ÙƒÙ„ Ø´ÙŠØ¡ Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠ.</p>\n        ',footerContent:'\n            <div style="display: flex; justify-content: center; gap: 16px; width: 100%;">\n                <button id="confirmClearExpensesOnlyBtn" class="btn btn-warning">Ù…Ø³Ø­ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙÙ‚Ø·</button>\n                <button id="confirmClearAllBtn" class="btn btn-reset">Ù†Ø¹Ù…ØŒ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>\n            </div>\n        '}),de=ie.element.querySelector("#confirmClearExpensesOnlyBtn"),le=ie.element.querySelector("#confirmClearAllBtn");function ce(t){Object.assign(e,t),ue()}function ue(){const t=Ie();!async function(t){if(n)return void(r=!0);n=!0,l.innerHTML="";const s=(e.currentPage-1)*o,a=s+o,i=t.slice(s,a);if(0===i.length){const t=e.expenses.length>0?"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª ØªØ·Ø§Ø¨Ù‚ Ø¨Ø­Ø«Ùƒ.":"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯.";l.innerHTML=`<tr><td colspan="9" style="text-align:center; padding: 20px;">${t}</td></tr>`}else{const t=e=>{const t=document.createElement("td");return t.textContent=e,t},n=(n,r)=>{const o=document.createElement("tr"),a=e.expenseTypes.find(e=>e.id===n.type),i=s+r+1;o.appendChild(t(i));const d=a?a.displayName:n.type?"Ù†ÙˆØ¹ Ù…Ø®ØµØµ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ":'<span style="color: var(--warning-color);">Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©</span>',l=t("");l.innerHTML=d,o.appendChild(l);let c=(n.desc||"").replace(/â­\s*/g,"")||'<span style="color: var(--warning-color);">Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©</span>';n.recurringTemplateId&&(c='<span class="recurring-indicator" title="Ù…ØµØ±ÙˆÙ Ù…ØªÙƒØ±Ø±">â­ </span>'+c);const u=t("");u.innerHTML=c,o.appendChild(u);const p=Object.keys(n.details||{}).length>0?function(t){const n=e.expenseTypes.find(e=>e.id===t.type);if(n&&n.fields&&n.fields.length>0)return n.fields.map(e=>{const n=t.details[e.name];return null==n?null:`${e.label}: ${n}`}).filter(Boolean).join("ØŒ ");if(t.details&&Object.keys(t.details).length>0)return Object.values(t.details).join("ØŒ ");return""}(n):'<span style="color: var(--warning-color);">Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©</span>',m=t("");m.innerHTML=p,o.appendChild(m),o.appendChild(t(`${n.total.toFixed(2)} Ø¯.Øª`));const g=document.createElement("td");let y="Ø¨Ø§Ù„ØªØ³Ø§ÙˆÙŠ";"percentage"===n.splitMethod?y=`Ù†Ø³Ø¨Ø© (${n.splitDetails.you}% / ${n.splitDetails.partner}%)`:"fixed"===n.splitMethod&&(y=`Ù…Ø­Ø¯Ø¯ (${n.splitDetails.you.toFixed(2)} / ${n.splitDetails.partner.toFixed(2)})`),g.textContent=y,o.appendChild(g),o.appendChild(t("you"===n.payer?"Ø£Ù†Øª":"Ø´Ø±ÙŠÙƒÙƒ")),o.appendChild(t(function(e){const t=new Date(e);return isNaN(t.getTime())||!e?"ØªØ§Ø±ÙŠØ® ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ":t.toLocaleDateString("ar-EG",{year:"numeric",month:"long",day:"numeric"})}(n.date)));const f=document.createElement("td");return f.innerHTML=`<div class="action-buttons"><button class="edit-btn" data-id="${n.id}">ØªØ¹Ø¯ÙŠÙ„</button><button class="delete-btn" data-id="${n.id}">Ø­Ø°Ù</button></div>`,o.appendChild(f),o},r=async e=>{const t=document.createDocumentFragment();for(const r of e){const e=n(r.expense,r.index);t.appendChild(e)}l.appendChild(t),await new Promise(e=>setTimeout(e,0))},o=i.map((e,t)=>({expense:e,index:t})),a=3;for(let e=0;e<o.length;e+=a){const t=o.slice(e,e+a);await r(t)}}n=!1,r&&(r=!1,ue())}(t),function(){let t=0,n=0,r=0,o=0;e.expenses.forEach(e=>{"you"===e.payer?t+=e.total:n+=e.total;let s=0,a=0;switch(e.splitMethod){case"percentage":s=e.total*(e.splitDetails.you/100),a=e.total*(e.splitDetails.partner/100);break;case"fixed":s=e.splitDetails.you,a=e.splitDetails.partner;break;default:s=e.total/2,a=e.total/2}r+=s,o+=a});const s=t+n,a=t-r;let i="Ø§Ù„ØªØ³ÙˆÙŠØ© ØªÙ…ØªØŒ Ù„Ø§ Ø£Ø­Ø¯ Ù…Ø¯ÙŠÙ† Ù„Ù„Ø¢Ø®Ø±.";a>0?i=`ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¯ÙØ¹ Ø´Ø±ÙŠÙƒÙƒ Ù„Ùƒ ${a.toFixed(2)} Ø¯.Øª`:a<0&&(i=`ÙŠØ¬Ø¨ Ø£Ù† ØªØ¯ÙØ¹ Ù„Ø´Ø±ÙŠÙƒÙƒ ${Math.abs(a).toFixed(2)} Ø¯.Øª`);const d=Math.abs(a);u.textContent=`${t.toFixed(2)} Ø¯.Øª`,p.textContent=`${n.toFixed(2)} Ø¯.Øª`,m.textContent=`${d.toFixed(2)} Ø¯.Øª`,g.textContent=`${s.toFixed(2)} Ø¯.Øª`,c.innerHTML=`\n            <div class="total-item">ğŸ‘¤ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø§ Ø¯ÙØ¹ØªÙ‡ Ø£Ù†Øª: <strong>${t.toFixed(2)} Ø¯.Øª</strong></div>\n            <div class="total-item">ğŸ§¾ Ø­ØµØªÙƒ Ø§Ù„ÙØ¹Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª: <strong>${r.toFixed(2)} Ø¯.Øª</strong></div>\n            <hr>\n            <div class="total-item">ğŸ‘¥ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø§ Ø¯ÙØ¹Ù‡ Ø´Ø±ÙŠÙƒÙƒ: <strong>${n.toFixed(2)} Ø¯.Øª</strong></div>\n            <div class="total-item">ğŸ§¾ Ø­ØµØªÙ‡ Ø§Ù„ÙØ¹Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª: <strong>${o.toFixed(2)} Ø¯.Øª</strong></div>\n            <hr>\n            <div class="total-item">ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª: <strong>${s.toFixed(2)} Ø¯.Øª</strong></div>\n            <div class="difference">âš–ï¸ ${i}</div>`}(),function(){L.innerHTML="";const t=e.budgets.filter(e=>me.getCurrentPeriodId(e.periodType)===e.periodId);if(0===t.length)return void(L.innerHTML='<p class="placeholder-text">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª Ù†Ø´Ø·Ø© Ù„Ù„ÙØªØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©.</p>');t.forEach(t=>{const n=e.expenseTypes.find(e=>e.id===t.categoryId);if(!n)return;const r=me.getDateRangeFromPeriodId(t.periodId),o=e.expenses.filter(e=>e.type===t.categoryId&&e.date>=r.start&&e.date<=r.end).reduce((e,t)=>e+t.total,0),s=t.amount>0?o/t.amount*100:0,a=t.amount-o;let i="low";s>90?i="high":s>70&&(i="medium");const d=document.createElement("div");d.className="budget-item",d.innerHTML=`\n                <div class="budget-item-header">\n                    <span class="budget-item-category">${n.displayName} (${me.periodTypeToText[t.periodType]})</span>\n                    <span class="budget-item-amount">${o.toFixed(2)} / ${t.amount.toFixed(2)} Ø¯.Øª</span>\n                </div>\n                <div class="progress-bar-container">\n                    <div class="progress-bar-fill ${i}" style="width: ${Math.min(s,100)}%;"></div>\n                </div>\n                <div class="budget-item-footer ${a<0?"over-budget":""}">\n                    ${a>=0?`Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${a.toFixed(2)} Ø¯.Øª`:`ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø¨Ù€: ${Math.abs(a).toFixed(2)} Ø¯.Øª`}\n                </div>`,L.appendChild(d)})}(),function(t){const n=Math.ceil(t.length/o);C.textContent=`ØµÙØ­Ø© ${e.currentPage} Ù…Ù† ${n>0?n:1}`,B.disabled=1===e.currentPage,D.disabled=e.currentPage===n||0===n}(t)}const pe=indexedDB.open("SharedExpensesDB",7);pe.onerror=function(){console.error("ÙØ´Ù„ ÙØªØ­ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª IndexedDB"),ge("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙƒØ¨ÙŠØ± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!","error")},pe.onsuccess=function(e){t=e.target.result,setTimeout(ve,0)},pe.onupgradeneeded=function(e){if(t=e.target.result,!t.objectStoreNames.contains("expenses")){t.createObjectStore("expenses",{keyPath:"id"}).createIndex("type","type",{unique:!1})}if(t.objectStoreNames.contains("expenseTypes")||t.createObjectStore("expenseTypes",{keyPath:"id"}),!t.objectStoreNames.contains("budgets")){t.createObjectStore("budgets",{keyPath:"budgetId"}).createIndex("periodId","periodId",{unique:!1})}t.objectStoreNames.contains("recurringExpenses")||t.createObjectStore("recurringExpenses",{keyPath:"id"})};const me={getWeekNumber:function(e){(e=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate()))).setUTCDate(e.getUTCDate()+4-(e.getUTCDay()||7));const t=new Date(Date.UTC(e.getUTCFullYear(),0,1));return Math.ceil(((e-t)/864e5+1)/7)},getCurrentPeriodId:function(e,t=new Date){const n=t.getFullYear();switch(e){case"weekly":return`${n}-W${this.getWeekNumber(t).toString().padStart(2,"0")}`;case"monthly":return`${n}-${(t.getMonth()+1).toString().padStart(2,"0")}`;case"quarterly":return`${n}-Q${Math.floor(t.getMonth()/3)+1}`;case"semi-annually":return`${n}-H${t.getMonth()<6?1:2}`;case"annually":return`${n}`;default:return null}},getDateRangeFromPeriodId:function(e){const[t,n]=e.split("-"),r=parseInt(t);if(e.includes("-W")){const e=parseInt(n.substring(1)),t=new Date(r,0,1+7*(e-1)),o=t.getDay()||7;t.setDate(t.getDate()+1-o);const s=new Date(t),a=new Date(t);return a.setDate(t.getDate()+6),{start:s.toISOString().slice(0,10),end:a.toISOString().slice(0,10)}}if(e.includes("-Q")){const e=3*(parseInt(n.substring(1))-1),t=new Date(r,e,1),o=new Date(r,e+3,0);return{start:t.toISOString().slice(0,10),end:o.toISOString().slice(0,10)}}if(e.includes("-H")){const e=1===parseInt(n.substring(1))?0:6,t=new Date(r,e,1),o=new Date(r,e+6,0);return{start:t.toISOString().slice(0,10),end:o.toISOString().slice(0,10)}}if(n&&2===n.length){const e=parseInt(n)-1,t=new Date(r,e,1),o=new Date(r,e+1,0);return{start:t.toISOString().slice(0,10),end:o.toISOString().slice(0,10)}}return{start:`${r}-01-01`,end:`${r}-12-31`}},periodTypeToText:{weekly:"Ø£Ø³Ø¨ÙˆØ¹ÙŠ",monthly:"Ø´Ù‡Ø±ÙŠ",quarterly:"Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠ","semi-annually":"Ù†ØµÙ Ø³Ù†ÙˆÙŠ",annually:"Ø³Ù†ÙˆÙŠ"}};function ge(e,t="info",n=5e3){const r=document.createElement("div");r.className=`alert alert-${t}`,r.textContent=e,r.setAttribute("role","alert"),r.style.cssText=`\n            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);\n            padding: 16px 32px; border-radius: var(--border-radius);\n            background-color: ${"success"===t?"var(--success-color)":"var(--danger-color)"};\n            color: var(--text-white); z-index: 2000; box-shadow: var(--box-shadow-lg);\n            opacity: 0; transition: opacity 0.3s, top 0.3s;\n        `,document.body.appendChild(r),setTimeout(()=>{r.style.opacity="1",r.style.top="40px"},10),setTimeout(()=>{r.style.opacity="0",r.style.top="20px",setTimeout(()=>r.remove(),300)},n)}function ye(e){return`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")}`}function fe(t){const n=e.expenseTypes.find(e=>e.id===t);if(i.innerHTML="",n&&n.fields.length>0){const e=document.createElement("div");e.className="expense-type-fields",n.fields.forEach(t=>{const n=document.createElement("div");n.className="field-group";const r=document.createElement("label");r.htmlFor=t.name,r.textContent=t.label;const o=document.createElement("input");o.type="number",o.id=t.name,o.name=t.name,o.min="0",o.step="0.01",o.value="0.00",o.required=!0,n.appendChild(r),n.appendChild(o),e.appendChild(n)}),i.appendChild(e),e.addEventListener("input",()=>be())}else i.innerHTML="<p>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ Ù„Ø¸Ù‡ÙˆØ± Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©</p>";be()}function be(t=!1){let n=0;const r={},o=a.value,s=e.expenseTypes.find(e=>e.id===o);if(s&&s.fields.length>0){let e=0;s.fields.forEach((t,n)=>{const o=document.getElementById(t.name),a=parseFloat(o?.value)||0;if(r[t.name]=a,0===n)e=a;else{switch(s.fields[n-1].operator){case"+":default:e+=a;break;case"-":e-=a;break;case"*":e*=a;break;case"/":0!==a?e/=a:e=1/0}}}),n=e}if(isFinite(n)?(d.textContent=`Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${n.toFixed(2)} Ø¯.Øª`,d.style.color="var(--success-color)"):(n=0,d.textContent="Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø©",d.style.color="var(--danger-color)"),t)return{total:n,details:r}}async function ve(){t&&(await xe(),0===e.expenseTypes.length&&(await new Promise(e=>{const n=[{id:"food",displayName:"Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©",fields:[{name:"weight",label:"Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…)",operator:"*"},{name:"pricePerKilo",label:"Ø³Ø¹Ø± Ø§Ù„ÙƒÙŠÙ„Ùˆ",operator:"+"},{name:"load",label:"Ø§Ù„Ø­Ù…ÙˆÙ„Ø©",operator:"+"}]},{id:"advertising",displayName:"Ø¯Ø¹Ø§ÙŠØ© ÙˆØ¥Ø¹Ù„Ø§Ù†",fields:[{name:"meters",label:"Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù…ØªØ§Ø±",operator:"*"},{name:"pricePerMeter",label:"Ø³Ø¹Ø± Ø§Ù„Ù…ØªØ±",operator:"+"}]},{id:"equipment",displayName:"Ù…Ø¹Ø¯Ø§Øª ÙˆØ£Ø¯ÙˆØ§Øª",fields:[{name:"quantity",label:"Ø§Ù„Ø¹Ø¯Ø¯",operator:"*"},{name:"unitPrice",label:"Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©",operator:"+"}]},{id:"operational",displayName:"ØªØ´ØºÙŠÙ„ÙŠØ©",fields:[{name:"price",label:"Ø§Ù„Ø³Ø¹Ø±",operator:"+"}]},{id:"misc",displayName:"Ù†Ø«Ø±ÙŠØ©",fields:[{name:"price",label:"Ø§Ù„Ø³Ø¹Ø±",operator:"+"}]}],r=t.transaction(["expenseTypes"],"readwrite"),o=r.objectStore("expenseTypes");n.forEach(e=>o.add(e)),r.oncomplete=e}),await xe()),await Ee(),await new Promise(n=>{const r=t.transaction(["recurringExpenses"],"readonly").objectStore("recurringExpenses").getAll();r.onsuccess=()=>{e.recurringExpenses=r.result,n()},r.onerror=()=>{ge("âŒ ÙØ´Ù„Øª Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©.","error"),n()}}),await async function(){return 0===e.recurringExpenses.length?Promise.resolve():new Promise(n=>{const r=new Date;r.setHours(0,0,0,0);let o=0,s=[];const a=t.transaction(["expenses","recurringExpenses"],"readwrite"),i=a.objectStore("recurringExpenses"),d=a.objectStore("expenses"),l=i.getAll();l.onsuccess=()=>{l.result.forEach(e=>{let t=new Date(e.nextDueDate+"T00:00:00");for(;t<=r;){const n={...e.baseExpenseData,id:Date.now()+Math.random(),date:ye(t),recurringTemplateId:e.id};d.add(n),s.push(n),o++;const r=Te(ye(t),e.frequency);e.nextDueDate=r,t=new Date(r+"T00:00:00")}i.put(e)})},a.oncomplete=()=>{o>0&&(ce({expenses:[...e.expenses,...s]}),ge(`âœ” ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ${o} Ù…ØµØ±ÙˆÙ Ù…ØªÙƒØ±Ø± ÙØ§Ø¦Øª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.`,"success")),n()},a.onerror=()=>{ge("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©.","error"),n()}})}(),await he(),we(a),we(E,!0),ue())}function xe(){return new Promise(e=>{const n=t.transaction(["expenseTypes"],"readonly").objectStore("expenseTypes").getAll();n.onsuccess=()=>{ce({expenseTypes:n.result}),e()},n.onerror=()=>{ge("âŒ ÙØ´Ù„Øª Ù‚Ø±Ø§Ø¡Ø© Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª.","error"),e()}})}function he(){return new Promise(e=>{const n=t.transaction(["expenses"],"readonly").objectStore("expenses").getAll();n.onsuccess=()=>{ce({expenses:n.result}),e()},n.onerror=()=>{ge("âŒ ÙØ´Ù„Øª Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª.","error"),e()}})}function Ee(){return new Promise(e=>{const n=t.transaction(["budgets"],"readonly").objectStore("budgets").getAll();n.onsuccess=()=>{ce({budgets:n.result}),e()},n.onerror=()=>{ge("âŒ ÙØ´Ù„Øª Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª.","error"),e()}})}function Ie(){let t=[...e.expenses];const{search:n,type:r,startDate:o,endDate:s}=e.filters;return n&&(t=t.filter(e=>e.desc.toLowerCase().includes(n.toLowerCase()))),"all"!==r&&(t=t.filter(e=>e.type===r)),o&&(t=t.filter(e=>e.date>=o)),s&&(t=t.filter(e=>e.date<=s)),t.sort((e,t)=>new Date(t.date)-new Date(e.date))}function we(t,n=!1){const r=t.value;if(t.innerHTML="",n){const e=document.createElement("option");e.value="all",e.textContent="ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹",t.appendChild(e)}else{const e=document.createElement("option");e.value="",e.textContent="Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ",t.appendChild(e)}e.expenseTypes.forEach(e=>{const n=document.createElement("option");n.value=e.id,n.textContent=e.displayName,t.appendChild(n)}),t.value=r}function Te(e,t){const n=new Date(e);switch(t){case"weekly":n.setDate(n.getDate()+7);break;case"monthly":n.setMonth(n.getMonth()+1);break;case"annually":n.setFullYear(n.getFullYear()+1)}return ye(n)}function Se(e){if(!t)return;const n=t.transaction(["expenses"],"readwrite");n.objectStore("expenses").delete(e),n.oncomplete=()=>{he().then(()=>ge("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙ.","success"))},n.onerror=()=>ge("âŒ ÙØ´Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø°Ù.","error")}function $e(){s.reset(),f.value=(new Date).toISOString().split("T")[0],W.parentElement.style.display="flex",W.dispatchEvent(new Event("change")),fe(""),e.editMode&&ce({editMode:!1,currentEditId:null}),v.textContent="Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ±ÙˆÙ",v.style.width="100%",x.style.display="none",N.value="equal",N.dispatchEvent(new Event("change")),P.value=50,A.value=50,_.value="",U.value=""}function Be(){K.innerHTML="",e.expenseTypes.forEach(e=>{const t=document.createElement("div");t.className="type-editor-item",t.dataset.typeId=e.id;let n=e.fields.map((e,t)=>`<div class="field-editor-row" data-field-index="${t}"><div><label>Ø§Ø³Ù… Ø§Ù„Ø­Ù‚Ù„</label><input type="text" value="${e.label}" class="field-name-input" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø³Ø¹Ø±"></div><div><label>Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠØ©</label><div class="operator-selector"><button data-op="+" class="${"+"===e.operator?"active":""}">+</button><button data-op="*" class="${"*"===e.operator?"active":""}">*</button><button data-op="-" class="${"-"===e.operator?"active":""}">-</button><button data-op="/" class="${"/"===e.operator?"active":""}">/</button></div></div><button class="btn btn-reset delete-field-btn" aria-label="Ø­Ø°Ù Ø§Ù„Ø­Ù‚Ù„">&times;</button></div>`).join("");t.innerHTML=`<div class="type-editor-header"><input type="text" value="${e.displayName}" class="type-name-input" placeholder="Ø§Ø³Ù… Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ"><div class="type-editor-actions"><button class="btn btn-add save-type-btn">Ø­ÙØ¸</button><button class="btn btn-reset delete-type-btn">Ø­Ø°Ù</button></div></div><div class="field-editor-list">${n}</div><button class="btn add-field-btn">+ Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„</button><div class="formula-preview">${function(e){let t="";e.fields&&e.fields.forEach((n,r)=>{const o=n.label.trim()||`Ø­Ù‚Ù„ ${r+1}`;if(0===r)t=`(${o})`;else{const n=e.fields[r-1].operator||"+";t=`(${t} ${n} ${o})`}});return`<span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ = </span>${t||"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù‚ÙˆÙ„"}`}(e)}</div>`,K.appendChild(t)}),K.querySelectorAll(".type-editor-item").forEach(n=>{const r=n.dataset.typeId;n.querySelector(".save-type-btn").addEventListener("click",()=>function(n){const r=document.querySelector(`.type-editor-item[data-type-id="${n}"]`),o=e.expenseTypes.findIndex(e=>e.id==n);if(-1===o)return;const s=r.querySelector(".type-name-input").value.trim();if(!s)return void ge("âŒ Ø§Ø³Ù… Ø§Ù„Ù†ÙˆØ¹ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ§Ø±ØºØ§Ù‹.","error");const i=[];r.querySelectorAll(".field-editor-row").forEach((t,n)=>{const r=t.querySelector(".field-name-input").value.trim(),s=t.querySelector(".operator-selector .active");i.push({name:e.expenseTypes[o].fields[n]?.name||`field_${Date.now()}_${n}`,label:r||`Ø­Ù‚Ù„ ${n+1}`,operator:s?s.dataset.op:"+"})});const d={...e.expenseTypes[o],displayName:s,fields:i},l=t.transaction(["expenseTypes"],"readwrite");l.objectStore("expenseTypes").put(d),l.oncomplete=()=>{xe().then(()=>{ge("âœ” ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!","success"),Be(),we(a),we(E,!0)})}}(r)),n.querySelector(".delete-type-btn").addEventListener("click",()=>async function(e){const n=await function(e){return new Promise(n=>{const r=new Promise(n=>{const r=t.transaction(["expenses"],"readonly").objectStore("expenses").index("type").count(e);r.onsuccess=()=>n(r.result>0),r.onerror=()=>n(!0)}),o=new Promise(n=>{const r=t.transaction(["budgets"],"readonly").objectStore("budgets").getAll();r.onsuccess=()=>{const t=r.result.some(t=>t.categoryId===e);n(t)},r.onerror=()=>n(!0)}),s=new Promise(n=>{const r=t.transaction(["recurringExpenses"],"readonly").objectStore("recurringExpenses").getAll();r.onsuccess=()=>{const t=r.result.some(t=>t.baseExpenseData.type===e);n(t)},r.onerror=()=>n(!0)});Promise.all([r,o,s]).then(e=>{const[t,r,o]=e;n(t||r||o)})})}(e);if(n)ge("âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹ Ù„ÙˆØ¬ÙˆØ¯ Ù…ØµØ±ÙˆÙØ§Øª Ù…Ø³Ø¬Ù„Ø© Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡.","error");else if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹ØŸ")){const n=t.transaction(["expenseTypes"],"readwrite");n.objectStore("expenseTypes").delete(e),n.onerror=()=>ge("âŒ ÙØ´Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ø­Ø°Ù Ø§Ù„Ù†ÙˆØ¹.","error"),n.oncomplete=()=>{xe().then(()=>{ge("ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­.","success"),Be(),we(a),we(E,!0)})}}}(r)),n.querySelector(".add-field-btn").addEventListener("click",()=>function(t){const n=e.expenseTypes.findIndex(e=>e.id==t);if(-1===n)return;const r=document.querySelector(`.type-editor-item[data-type-id="${t}"]`);if(!r)return;const o=r.querySelector(".type-name-input").value.trim();e.expenseTypes[n].displayName=o||"Ù†ÙˆØ¹ Ø¬Ø¯ÙŠØ¯";const s=[];r.querySelectorAll(".field-editor-row").forEach((t,r)=>{const o=t.querySelector(".field-name-input").value.trim(),a=t.querySelector(".operator-selector .active"),i=a?a.dataset.op:"+",d=e.expenseTypes[n].fields[r]?.name||`field_${Date.now()}_${r}`;s.push({name:d,label:o||`Ø­Ù‚Ù„ ${r+1}`,operator:i})}),e.expenseTypes[n].fields=s,e.expenseTypes[n].fields.push({name:`field_${Date.now()}`,label:"",operator:"+"}),Be()}(r)),n.querySelectorAll(".delete-field-btn").forEach(t=>{t.addEventListener("click",t=>{const n=parseInt(t.target.closest(".field-editor-row").dataset.fieldIndex);!function(t,n){const r=e.expenseTypes.findIndex(e=>e.id==t);r>-1&&(e.expenseTypes[r].fields.splice(n,1),Be())}(r,n)})}),n.querySelectorAll(".operator-selector button").forEach(e=>{e.addEventListener("click",e=>{const t=e.target.parentElement;t.querySelector(".active")?.classList.remove("active"),e.target.classList.add("active")})})})}function De(){Z.innerHTML="";const n=document.createElement("div");n.className="budget-settings-list";const r=e.expenseTypes.filter(t=>e.budgets.some(e=>e.categoryId===t.id));0===r.length?n.innerHTML="<p class=\"placeholder-text\">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ 'Ø¥Ø¶Ø§ÙØ©' Ù„Ù„Ø¨Ø¯Ø¡.</p>":r.forEach(t=>{const r=e.budgets.find(e=>e.categoryId===t.id),o=Object.keys(me.periodTypeToText).map(e=>`<option value="${e}" ${r.periodType===e?"selected":""}>${me.periodTypeToText[e]}</option>`).join(""),s=document.createElement("div");s.className="budget-setting-item",s.innerHTML=`\n                    <span class="budget-setting-name">${t.displayName}</span>\n                    <div class="budget-controls">\n                        <div class="budget-input-group">\n                            <input type="number" class="budget-input" data-category-id="${t.id}" value="${r.amount}" min="0" step="0.01">\n                            <span>Ø¯.Øª</span>\n                        </div>\n                        <select class="budget-period-select">${o}</select>\n                    </div>\n                    <button class="budget-item-delete-btn" data-budget-id="${r.budgetId}">&times;</button>\n                `,n.appendChild(s)}),Z.appendChild(n),Z.querySelectorAll(".budget-item-delete-btn").forEach(e=>{e.addEventListener("click",()=>function(e){if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©ØŸ"))return;const n=t.transaction(["budgets"],"readwrite");n.objectStore("budgets").delete(e),n.onerror=()=>ge("âŒ ÙØ´Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ø­Ø°Ù Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©.","error"),n.oncomplete=()=>{Ee().then(()=>De()),ge("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©.","success")}}(e.dataset.budgetId))})}function Ce(){if(0===e.budgets.length)return void ge("â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª Ù„Ø­Ø°ÙÙ‡Ø§.","info");if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§ØªØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.")){if(!t)return;const e=t.transaction(["budgets"],"readwrite");e.objectStore("budgets").clear(),e.oncomplete=()=>{ce({budgets:[]}),ge("ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª Ø¨Ù†Ø¬Ø§Ø­.","success")},e.onerror=()=>ge("âŒ ÙØ´Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ù…Ø³Ø­ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª.","error")}}function Le(){const t=re.element.querySelector("#recurringListContainer");t.innerHTML="",0!==e.recurringExpenses.length?e.recurringExpenses.forEach(e=>{const n=document.createElement("div");n.className="recurring-item";const r=document.createElement("div");r.className="recurring-item-details";const o=document.createElement("span");o.className="recurring-item-desc",o.textContent=e.baseExpenseData.desc;const s=document.createElement("span");s.className="recurring-item-info",s.innerHTML=`<strong>${e.baseExpenseData.total.toFixed(2)} Ø¯.Øª</strong> - ${me.periodTypeToText[e.frequency]}`,r.appendChild(o),r.appendChild(s);const a=document.createElement("div");a.className="recurring-item-actions";const i=document.createElement("button");i.className="btn btn-reset",i.textContent="Ø­Ø°Ù",i.onclick=()=>ke(e.id),a.appendChild(i),n.appendChild(r),n.appendChild(a),t.appendChild(n)}):t.innerHTML='<p class="placeholder-text">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª Ù…ØªÙƒØ±Ø±Ø© Ù…Ø­ÙÙˆØ¸Ø©.</p>'}function ke(n){const r=t.transaction(["recurringExpenses"],"readwrite");r.objectStore("recurringExpenses").delete(n),r.oncomplete=()=>{e.recurringExpenses=e.recurringExpenses.filter(e=>e.id!==n),ge("âœ” ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„Ù…ØªÙƒØ±Ø±.","success"),Le()},r.onerror=()=>ge("âŒ ÙØ´Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø°Ù.","error")}function Me(){if(!t)return;const e=t.transaction(["expenses"],"readwrite");e.objectStore("expenses").clear(),e.oncomplete=()=>{ce({expenses:[],currentPage:1}),ge("ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø¨Ù†Ø¬Ø§Ø­.","success")},e.onerror=()=>{ge("âŒ ÙØ´Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ù…Ø³Ø­ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª.","error")}}s.addEventListener("submit",function(n){if(n.preventDefault(),!document.getElementById("desc").value.trim())return void ge("âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙˆØµÙ Ù„Ù„Ù…ØµØ±ÙˆÙ (Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ / Ø§Ù„Ø®Ø¯Ù…Ø©).","error");const r=new Date;if(r.setHours(0,0,0,0),new Date(f.value+"T00:00:00")>r&&!W.checked&&!confirm("Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø°ÙŠ Ø£Ø¯Ø®Ù„ØªÙ‡ Ù‡Ùˆ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©ØŸ"))return;const o=a.value;if(!e.expenseTypes.find(e=>e.id===o))return void ge("âŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ù…ØµØ±ÙˆÙ ØµØ§Ù„Ø­.","error");const s=be(!0);if(s.total<0)ge("âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ Ø¨Ù‚ÙŠÙ…Ø© Ø³Ø§Ù„Ø¨Ø©.","error");else{if("fixed"===N.value){const e=parseFloat(_.value)||0,t=parseFloat(U.value)||0;if(Math.abs(e+t-s.total)>.01)return void ge("âŒ Ø®Ø·Ø£: Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø­ØµØµ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù„Ø§ ÙŠØ³Ø§ÙˆÙŠ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„ÙØ§ØªÙˆØ±Ø©. ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­ØµØµ.","error")}s.total<=0&&!W.checked?ge("âŒ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„ØµÙØ±.","error"):W.checked?function(n){const r=N.value;let o={};"percentage"===r?o={you:parseFloat(P.value),partner:parseFloat(A.value)}:"fixed"===r&&(o={you:parseFloat(_.value),partner:parseFloat(U.value)});const s={type:a.value,desc:document.getElementById("desc").value.trim(),payer:document.getElementById("payer").value,total:n.total,details:n.details,splitMethod:r,splitDetails:o},i={id:`rec_${Date.now()}`,frequency:Y.value,nextDueDate:f.value,baseExpenseData:s},d=t.transaction(["recurringExpenses"],"readwrite"),l=d.objectStore("recurringExpenses").add(i);l.onsuccess=()=>{e.recurringExpenses.push(i),ge("âœ” ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„Ù…ØªÙƒØ±Ø± Ø¨Ù†Ø¬Ø§Ø­!","success"),$e()},l.onerror=()=>ge("âŒ ÙØ´Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„Ù…ØªÙƒØ±Ø±.","error")}(s):function(n){const r=N.value;let o={};"percentage"===r?o={you:parseFloat(P.value),partner:parseFloat(A.value)}:"fixed"===r&&(o={you:parseFloat(_.value),partner:parseFloat(U.value)});const s={id:e.editMode?e.currentEditId:Date.now(),type:a.value,desc:document.getElementById("desc").value.trim(),payer:document.getElementById("payer").value,date:f.value,total:n.total,details:n.details,splitMethod:r,splitDetails:o},i=t.transaction(["expenses"],"readwrite").objectStore("expenses"),d=e.editMode?i.put(s):i.add(s);d.onsuccess=()=>{he().then(()=>{ge(`âœ” ${e.editMode?"ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª":"ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ±ÙˆÙ"}!`,"success"),ce({editMode:!1,currentEditId:null}),$e()})},d.onerror=()=>ge(`âŒ ÙØ´Ù„Øª Ø¹Ù…Ù„ÙŠØ© ${e.editMode?"Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª":"Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ±ÙˆÙ"}.`,"error")}(s)}}),x.addEventListener("click",$e),a.addEventListener("change",()=>fe(a.value)),y.addEventListener("click",t=>{0!==e.expenses.length?ie.open(t.currentTarget):ge("â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù…Ø³Ø­Ù‡Ø§.","info")}),de.addEventListener("click",()=>{Me(),ie.close()}),le.addEventListener("click",()=>{Me(),function(){if(!t)return;const n=t.transaction(["recurringExpenses"],"readwrite");n.objectStore("recurringExpenses").clear(),n.oncomplete=()=>{e.recurringExpenses=[],ge("ØªÙ… Ù…Ø³Ø­ Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©.","success"),Le()},n.onerror=()=>ge("âŒ ÙØ´Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ù…Ø³Ø­ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©.","error")}(),Ce(),ie.close()}),b.addEventListener("click",function(){if(0===e.expenses.length)return void ge("â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§.","info");const t=`#TYPES_DEFINITION#${JSON.stringify(e.expenseTypes)}`,n=e.expenses.map(e=>{const t=e=>`"${String(e).replace(/"/g,'""')}"`;return[e.id,e.type,t(e.desc),e.payer,e.total,e.date,t(JSON.stringify(e.details||{})),t(e.splitMethod||"equal"),t(JSON.stringify(e.splitDetails||{})),t(e.recurringTemplateId||"")].join(",")}),r=[t,["id","type","desc","payer","total","date","details_json","splitMethod","splitDetails_json","recurringTemplateId"].join(","),...n].join("\n"),o=new Uint8Array([239,187,191]),s=new Blob([o,r],{type:"text/csv;charset=utf-8;"}),a=document.createElement("a");a.href=URL.createObjectURL(s),a.download=`Ù…ØµØ±ÙˆÙØ§ØªÙŠ_${(new Date).toISOString().slice(0,10)}.csv`,document.body.appendChild(a),a.click(),document.body.removeChild(a)}),S.addEventListener("click",()=>$.click()),$.addEventListener("change",async function(n){const r=n.target.files[0];if(!r)return;const o=new FileReader;o.onload=async function(n){let r=n.target.result,o=null;if(r.startsWith("#TYPES_DEFINITION#")){const e=r.split("\n"),t=e.shift().substring(18);try{o=JSON.parse(t)}catch(e){return void ge("âŒ ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ ØªØ¹Ø±ÙŠÙØ§Øª Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ ÙÙŠ Ù…Ù„Ù Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯.","error")}r=e.join("\n")}try{const n=function(e){const t=e=>{const t=[];let n="",r=!1;for(let o=0;o<e.length;o++){const s=e[o];'"'===s?r&&'"'===e[o+1]?(n+='"',o++):r=!r:","!==s||r?n+=s:(t.push(n),n="")}return t.push(n),t},n=e.trim().split("\n"),r=n.shift();if(!r)return ge("âŒ Ù…Ù„Ù CSV ÙØ§Ø±Øº Ø£Ùˆ ØºÙŠØ± ØµØ§Ù„Ø­.","error"),null;const o=r.split(",").map(e=>e.trim().replace(/"/g,"")),s=["id","total","payer","date"];for(const e of s)if(!o.includes(e))return ge(`âŒ Ù…Ù„Ù CSV ØºÙŠØ± ØµØ§Ù„Ø­. Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø­ÙŠÙˆÙŠ "${e}" ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.`,"error"),null;const a=o.indexOf("id"),i=o.indexOf("type"),d=o.indexOf("desc"),l=o.indexOf("payer"),c=o.indexOf("total"),u=o.indexOf("date"),p=o.indexOf("details_json"),m=o.indexOf("splitDetails_json"),g=o.indexOf("splitMethod"),y=o.indexOf("recurringTemplateId");let f=0;const b=n.map(e=>{if(!e.trim())return null;const n=t(e),r=e=>(n[e]||"").trim();try{const e=Number(r(a)),t=parseFloat(r(c)),n=r(l),o=r(u);return!isNaN(e)&&isFinite(t)&&n&&o?{id:e,total:t,payer:n,date:o,type:r(i),desc:r(d),details:JSON.parse(r(p)||"{}"),splitDetails:JSON.parse(r(m)||"{}"),splitMethod:r(g)||"equal",recurringTemplateId:r(y)||null}:(f++,null)}catch(t){return console.error("Error parsing line:",e,t),f++,null}}).filter(Boolean);f>0&&ge(`âš ï¸ ØªÙ… ØªØ¬Ø§Ù‡Ù„ ${f} ØµÙÙˆÙ Ù„Ø¹Ø¯Ù… Ø§ÙƒØªÙ…Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ø§ Ø§Ù„Ø­ÙŠÙˆÙŠØ©.`,"warning");return b}(r);if(n){const r="Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙˆØ§Ù„Ø£Ù†ÙˆØ§Ø¹) ÙˆØ§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…Ù„Ù.";(0===e.expenses.length||confirm(r))&&(o&&await(s=o,new Promise((e,n)=>{if(!t||!s||0===s.length)return e();const r=t.transaction(["expenseTypes"],"readwrite"),o=r.objectStore("expenseTypes");o.clear(),s.forEach(e=>{o.add(e)}),r.oncomplete=()=>{console.log("ØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø¨Ù†Ø¬Ø§Ø­."),e()},r.onerror=e=>{console.error("ÙØ´Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª.",e.target.error),ge("âŒ ÙØ´Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹.","error"),n()}})),await xe(),function(e){const n=t.transaction(["expenses"],"readwrite"),r=n.objectStore("expenses");r.clear(),e.forEach(e=>{r.add(e)}),n.oncomplete=()=>{he().then(()=>{ge("âœ” ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø¨Ù†Ø¬Ø§Ø­!","success")})},n.onerror=()=>{ge("âŒ ÙØ´Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª.","error")}}(n))}}catch(e){console.error("Error during import:",e),ge("âŒ ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª.","error")}var s},o.readAsText(r),n.target.value=""}),l.addEventListener("click",t=>{const n=t.target;if("BUTTON"!==n.tagName)return;const r=Number(n.dataset.id),o=e.expenses.find(e=>e.id===r);o&&(n.classList.contains("delete-btn")?o.hasOwnProperty("recurringTemplateId")?(oe.element.dataset.expenseId=r,oe.element.dataset.templateId=o.recurringTemplateId,oe.open(t.target)):confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙ: "${o.desc}"ØŸ`)&&Se(r):n.classList.contains("edit-btn")&&function(t){const n=e.expenses.find(e=>e.id===t);if(!n)return;ce({editMode:!0,currentEditId:t}),document.getElementById("desc").value=n.desc,f.value=n.date,a.value=n.type,document.getElementById("payer").value=n.payer,fe(n.type),setTimeout(()=>{const e=n.details;for(const t in e){const n=document.getElementById(t);n&&(n.value=e[t])}be()},0),v.textContent="Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª",v.style.width="auto",x.style.display="inline-flex",W.checked=!1,W.dispatchEvent(new Event("change"));const r=n.splitMethod||"equal";N.value=r,N.dispatchEvent(new Event("change")),"percentage"===r?(P.value=n.splitDetails.you,A.value=n.splitDetails.partner):"fixed"===r&&(_.value=n.splitDetails.you,U.value=n.splitDetails.partner),window.scrollTo({top:0,behavior:"smooth"})}(r))}),se.addEventListener("click",()=>{Se(Number(oe.element.dataset.expenseId)),oe.close()}),ae.addEventListener("click",()=>{const e=Number(oe.element.dataset.expenseId),t=oe.element.dataset.templateId;Se(e),ke(t),oe.close()}),h.addEventListener("input",t=>ce({filters:{...e.filters,search:t.target.value},currentPage:1})),E.addEventListener("change",t=>ce({filters:{...e.filters,type:t.target.value},currentPage:1})),I.addEventListener("change",t=>ce({filters:{...e.filters,startDate:t.target.value},currentPage:1})),w.addEventListener("change",t=>ce({filters:{...e.filters,endDate:t.target.value},currentPage:1})),T.addEventListener("click",()=>{h.value="",E.value="all",I.value="",w.value="",ce({filters:{search:"",type:"all",startDate:"",endDate:""},currentPage:1})}),B.addEventListener("click",()=>{e.currentPage>1&&ce({currentPage:e.currentPage-1})}),D.addEventListener("click",()=>{const t=Math.ceil(Ie().length/o);e.currentPage<t&&ce({currentPage:e.currentPage+1})}),z.addEventListener("click",e=>{Be(),V.open(e.currentTarget)}),Q.addEventListener("click",function(){const e=`custom_${Date.now()}`,n={id:e,displayName:"Ù†ÙˆØ¹ Ø¬Ø¯ÙŠØ¯ (Ø§Ø¶ØºØ· Ù„Ù„Ø­ÙØ¸)",fields:[{name:`field_${Date.now()}`,label:"Ø§Ù„Ø³Ø¹Ø±",operator:"+"}]},r=t.transaction(["expenseTypes"],"readwrite");r.objectStore("expenseTypes").add(n),r.onerror=()=>ge("âŒ ÙØ´Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ø¥Ø¶Ø§ÙØ© Ù†ÙˆØ¹ Ø¬Ø¯ÙŠØ¯.","error"),r.oncomplete=()=>{xe().then(()=>{ge("âœ” ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù†ÙˆØ¹ Ø¬Ø¯ÙŠØ¯. Ù‚Ù… Ø¨ØªØ¹Ø¯ÙŠÙ„Ù‡ Ø«Ù… Ø§Ø¶ØºØ· Ø­ÙØ¸.","success"),Be();const t=K.querySelector(`[data-type-id="${e}"]`);t&&t.scrollIntoView({behavior:"smooth",block:"center"})})}}),G.addEventListener("click",e=>{De(),X.open(e.currentTarget)}),ee.addEventListener("click",function(){const e=Z.querySelectorAll(".budget-setting-item"),n=t.transaction(["budgets"],"readwrite"),r=n.objectStore("budgets");r.clear();const o=[];e.forEach(e=>{const t=e.querySelector(".budget-input").dataset.categoryId,n=parseFloat(e.querySelector(".budget-input").value),s=e.querySelector(".budget-period-select").value;if(n>0){const e=me.getCurrentPeriodId(s);if(!e)return;const a={budgetId:`${t}_${e}`,categoryId:t,periodId:e,periodType:s,amount:n};r.put(a),o.push(a)}}),n.oncomplete=()=>{ce({budgets:o}),ge("âœ” ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª Ø¨Ù†Ø¬Ø§Ø­!","success"),X.close()},n.onerror=()=>ge("âŒ ÙØ´Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ø­ÙØ¸ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª.","error")}),te.addEventListener("click",function(){if(document.getElementById("add-budget-form"))return;const n=e.budgets.map(e=>e.categoryId),r=e.expenseTypes.filter(e=>!n.includes(e.id));if(0===r.length)return void ge("â„¹ï¸ ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª Ù„Ø¯ÙŠÙ‡Ø§ Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø¨Ø§Ù„ÙØ¹Ù„.","info");const o=document.createElement("div");o.id="add-budget-form",o.className="add-budget-form";const s=r.map(e=>`<option value="${e.id}">${e.displayName}</option>`).join(""),a=Object.keys(me.periodTypeToText).map(e=>`<option value="${e}">${me.periodTypeToText[e]}</option>`).join("");o.innerHTML=`\n            <select id="newBudgetCategorySelect"><option value="">Ø§Ø®ØªØ± ÙØ¦Ø©...</option>${s}</select>\n            <div class="add-budget-form-inputs">\n                <input id="newBudgetAmountInput" type="number" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº" min="0" step="0.01">\n                <select id="newBudgetPeriodSelect">${a}</select>\n            </div>\n            <button id="confirmAddBudgetBtn" class="btn btn-add">Ø¥Ø¶Ø§ÙØ©</button>\n        `,Z.appendChild(o),document.getElementById("confirmAddBudgetBtn").addEventListener("click",()=>{const e=document.getElementById("newBudgetCategorySelect").value,n=parseFloat(document.getElementById("newBudgetAmountInput").value),r=document.getElementById("newBudgetPeriodSelect").value;if(!(e&&n>0))return void ge("âŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙØ¦Ø© ÙˆØ¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­.","error");const o=me.getCurrentPeriodId(r);if(!o)return void ge("âŒ ÙØªØ±Ø© Ø²Ù…Ù†ÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­Ø©.","error");const s={budgetId:`${e}_${o}`,categoryId:e,periodId:o,periodType:r,amount:n},a=t.transaction(["budgets"],"readwrite");a.objectStore("budgets").add(s),a.oncomplete=()=>{Ee().then(()=>De()),ge("âœ” ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©.","success")},a.onerror=()=>ge("âŒ ÙØ´Ù„Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©.","error")})}),k.addEventListener("click",Ce),M.addEventListener("click",function(){if(0===e.budgets.length)return void ge("â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§.","error");const t=e.budgets.map(e=>[e.budgetId,e.categoryId,e.periodId,e.periodType,e.amount].join(",")),n=[["budgetId","categoryId","periodId","periodType","amount"].join(","),...t].join("\n"),r=new Uint8Array([239,187,191]),o=new Blob([r,n],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a");s.href=URL.createObjectURL(o),s.download=`Ù…ÙŠØ²Ø§Ù†ÙŠØ§ØªÙŠ_${(new Date).toISOString().slice(0,10)}.csv`,document.body.appendChild(s),s.click(),document.body.removeChild(s)}),F.addEventListener("click",()=>j.click()),j.addEventListener("change",function(n){const r=n.target.files[0];if(!r)return;const o=new FileReader;o.onload=function(n){const r=n.target.result;try{const n=function(e){const t=e.trim().split("\n"),n=t.shift();if(!n)return[];const r=n.split(","),o=["budgetId","categoryId","periodId","periodType","amount"];for(const e of o)if(!r.includes(e))return ge(`âŒ Ù…Ù„Ù Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª ØºÙŠØ± ØµØ§Ù„Ø­. Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯: ${e}`,"error"),null;const s=r.indexOf("budgetId"),a=r.indexOf("categoryId"),i=r.indexOf("periodId"),d=r.indexOf("periodType"),l=r.indexOf("amount");return t.map(e=>{const t=e.split(",");try{const e={budgetId:t[s],categoryId:t[a],periodId:t[i],periodType:t[d],amount:parseFloat(t[l])};return!e.budgetId||isNaN(e.amount)?null:e}catch{return null}}).filter(Boolean)}(r);if(n){const r="Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…Ù„Ù.";(0===e.budgets.length||confirm(r))&&function(e){const n=t.transaction(["budgets"],"readwrite"),r=n.objectStore("budgets");r.clear(),e.forEach(e=>{r.add(e)}),n.oncomplete=()=>{Ee().then(()=>{ge("âœ” ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª Ø¨Ù†Ø¬Ø§Ø­!","success")})},n.onerror=()=>{ge("âŒ ÙØ´Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.","error")}}(n)}}catch(e){console.error("Error parsing budgets CSV:",e),ge("âŒ ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ù‡ Ù…Ù„Ù CSV ØµØ­ÙŠØ­.","error")}},o.readAsText(r),n.target.value=""}),W.addEventListener("change",()=>{R.style.display=W.checked?"block":"none"}),ne.addEventListener("click",e=>{Le(),re.open(e.currentTarget)}),N.addEventListener("change",e=>{const t=e.target.value;q.classList.toggle("visible","equal"!==t),O.classList.toggle("visible","percentage"===t),H.classList.toggle("visible","fixed"===t)}),P.addEventListener("input",()=>{const e=parseFloat(P.value)||0;e>100&&(P.value=100),e<0&&(P.value=0),A.value=100-P.value}),_.addEventListener("input",()=>{const e=be(!0).total,t=parseFloat(_.value)||0;t>e&&(_.value=e),t<0&&(_.value=0),U.value=(e-t).toFixed(2)}),i.addEventListener("input",()=>{const e=be(!0).total;if("fixed"===N.value){const t=parseFloat(_.value)||0;U.value=(e-t).toFixed(2)}});const Fe=document.getElementById("theme-toggle"),je=document.body,Ne=e=>{je.classList.toggle("dark-mode","dark"===e)};Fe.addEventListener("click",()=>{const e=je.classList.contains("dark-mode")?"light":"dark";localStorage.setItem("theme",e),Ne(e)}),f.value=ye(new Date),fe("");const qe=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");Ne(qe),"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("./sw.js").then(e=>console.log("ServiceWorker registration successful")).catch(e=>console.log("ServiceWorker registration failed: ",e))})});