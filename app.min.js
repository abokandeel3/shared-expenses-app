document.addEventListener("DOMContentLoaded",()=>{const e={expenses:[],expenseTypes:[],budgets:[],recurringExpenses:[],editMode:!1,currentEditId:null,currentPage:1,filters:{search:"",type:"all",startDate:"",endDate:""}};let t,n=!1,r=!1;const o=10,s=document.getElementById("expenseForm"),a=document.getElementById("expenseType"),i=document.getElementById("expenseFieldsContainer"),d=document.getElementById("totalLabel"),l=document.getElementById("expenseTableBody"),c=document.getElementById("totals"),u=document.querySelector(".you-paid"),p=document.querySelector(".partner-paid"),m=document.querySelector(".difference-amount"),g=document.querySelector(".total-paid-summary"),y=document.getElementById("resetBtn"),f=document.getElementById("date"),b=document.getElementById("exportBtn"),v=s.querySelector('button[type="submit"]'),x=document.getElementById("cancelEditBtn"),h=document.getElementById("searchInput"),E=document.getElementById("typeFilter"),I=document.getElementById("startDateFilter"),w=document.getElementById("endDateFilter"),T=document.getElementById("resetFiltersBtn"),S=document.getElementById("importBtn"),$=document.getElementById("importFile"),B=document.getElementById("prevPageBtn"),D=document.getElementById("nextPageBtn"),C=document.getElementById("pageInfo"),L=document.getElementById("budgetsListContainer"),k=document.getElementById("clearAllBudgetsBtn"),M=document.getElementById("exportBudgetsBtn"),F=document.getElementById("importBudgetsBtn"),j=document.getElementById("importBudgetsFile"),N=document.getElementById("splitMethodSelect"),q=document.getElementById("splitOptionsContainer"),O=document.getElementById("percentageInputs"),P=document.getElementById("yourPercentage"),A=document.getElementById("partnerPercentage"),H=document.getElementById("fixedInputs"),_=document.getElementById("yourFixedShare"),U=document.getElementById("partnerFixedShare"),W=document.getElementById("isRecurring"),R=document.getElementById("recurringOptions"),Y=document.getElementById("recurringFrequency");function J(e){const t={id:"",title:"نافذة منبثقة",bodyContent:"<p>محتوى افتراضي.</p>",footerContent:"",maxWidth:"700px",...e},n=document.createElement("div");n.id=t.id,n.className="modal-overlay",n.style.display="none";const r=t.id+"-title",o=`\n            <div class="modal-content" style="max-width: ${t.maxWidth};" role="dialog" aria-modal="true" aria-labelledby="${r}">\n                <div class="modal-header">\n                    <h3 id="${r}">${t.title}</h3>\n                    <button class="modal-close-btn" aria-label="إغلاق النافذة">&times;</button>\n                </div>\n                <div class="modal-body">\n                    ${t.bodyContent}\n                </div>\n                ${t.footerContent?`<div class="modal-footer" ${t.footerId?`id="${t.footerId}"`:""}>${t.footerContent}</div>`:""}\n            </div>\n        `;n.innerHTML=o,document.body.appendChild(n);const s=n.querySelector(".modal-close-btn"),a=n.querySelector(".modal-content");let i;const d=e=>{if("Tab"!==e.key)return;const t=Array.from(a.querySelectorAll("button, [href], input, select, textarea")),n=t[0],r=t[t.length-1];e.shiftKey&&document.activeElement===n?(r.focus(),e.preventDefault()):e.shiftKey||document.activeElement!==r||(n.focus(),e.preventDefault())},l=()=>{n.style.display="none",n.removeEventListener("keydown",d),i&&i.focus()};return s.addEventListener("click",l),n.addEventListener("click",e=>{e.target===n&&l()}),{id:t.id,element:n,open:e=>{i=e||document.activeElement,n.style.display="flex";const t=a.querySelector("button, [href], input, select, textarea");t&&t.focus(),n.addEventListener("keydown",d)},close:l}}const z=document.getElementById("customizeTypesBtn"),V=J({id:"customizeModal",title:"تخصيص أنواع المصروفات",bodyContent:'<div id="customizeModalBody"></div>',footerContent:'<button id="addNewTypeBtn" class="btn btn-add">إضافة نوع جديد</button>'}),K=V.element.querySelector("#customizeModalBody"),Q=V.element.querySelector("#addNewTypeBtn"),G=document.getElementById("manageBudgetsBtn"),X=J({id:"manageBudgetsModal",title:"⚙️ إدارة الميزانيات",footerId:"budgetsModalFooter",bodyContent:'<div id="budgetsModalBody"></div>',footerContent:'\n            <button id="saveBudgetsBtn" class="btn btn-export">حفظ التغييرات</button>\n            <button id="addNewBudgetBtn" class="btn btn-add">+ إضافة ميزانية</button>\n        '}),Z=X.element.querySelector("#budgetsModalBody"),ee=X.element.querySelector("#saveBudgetsBtn"),te=X.element.querySelector("#addNewBudgetBtn"),ne=document.getElementById("manageRecurringBtn"),re=J({id:"manageRecurringModal",title:"🔄 إدارة المصروفات المتكررة",bodyContent:'\n            <details class="collapsible-info">\n                <summary class="collapsible-title">ما هي المصروفات المتكررة؟ (اضغط للشرح)</summary>\n                <div class="collapsible-content">\n                    <p>هذه الميزة تسمح لك بحفظ المصروفات الثابتة (مثل الإيجار أو الفواتير) مرة واحدة فقط. سيقوم التطبيق بتسجيلها تلقائيًا في الجدول نيابة عنك كلما حان وقتها.</p>\n                    <p><b>ماذا سيحدث؟</b> عندما يحين موعد استحقاق مصروف متكرر وتفتح التطبيق، ستظهر لك رسالة تنبيه خضراء، وستجد المصروف الجديد قد أضيف تلقائيًا إلى قائمة المصروفات الرئيسية بالجدول وسيتم تحديده بنجمة ⭐.</p>\n                </div>\n            </details>\n            <hr class="modal-divider">\n            <div id="recurringListContainer"></div>\n        '}),oe=J({id:"deleteConfirmModal",title:"تأكيد الحذف",maxWidth:"500px",bodyContent:"<p>هذا المصروف تم إنشاؤه تلقائيًا. ماذا تريد أن تفعل؟</p>",footerContent:'\n            <div style="display: flex; justify-content: center; gap: 16px; width: 100%;">\n                <button id="confirmDeleteOnceBtn" class="btn btn-warning">حذف هذه المرة فقط</button>\n                <button id="confirmDeleteAllBtn" class="btn btn-reset">إيقاف التكرار نهائيًا</button>\n            </div>\n        '}),se=oe.element.querySelector("#confirmDeleteOnceBtn"),ae=oe.element.querySelector("#confirmDeleteAllBtn"),ie=J({id:"clearAllConfirmModal",title:"تأكيد الحذف الشامل",maxWidth:"550px",bodyContent:'\n            <p>أنت على وشك مسح جميع سجلات المصروفات من الجدول.</p>\n            <p class="description" style="margin-top: 10px;">هل تريد أيضًا حذف <b>قوالب المصروفات المتكررة</b> وجميع <b>الميزانيات</b> المحفوظة؟ <br>هذا الإجراء سيحذف كل شيء بشكل نهائي.</p>\n        ',footerContent:'\n            <div style="display: flex; justify-content: center; gap: 16px; width: 100%;">\n                <button id="confirmClearExpensesOnlyBtn" class="btn btn-warning">مسح المصروفات فقط</button>\n                <button id="confirmClearAllBtn" class="btn btn-reset">نعم، مسح الكل</button>\n            </div>\n        '}),de=ie.element.querySelector("#confirmClearExpensesOnlyBtn"),le=ie.element.querySelector("#confirmClearAllBtn");function ce(t){Object.assign(e,t),ue()}function ue(){const t=Ie();!async function(t){if(n)return void(r=!0);n=!0,l.innerHTML="";const s=(e.currentPage-1)*o,a=s+o,i=t.slice(s,a);if(0===i.length){const t=e.expenses.length>0?"لا توجد مصروفات تطابق بحثك.":"لا توجد مصروفات مسجلة بعد.";l.innerHTML=`<tr><td colspan="9" style="text-align:center; padding: 20px;">${t}</td></tr>`}else{const t=e=>{const t=document.createElement("td");return t.textContent=e,t},n=(n,r)=>{const o=document.createElement("tr"),a=e.expenseTypes.find(e=>e.id===n.type),i=s+r+1;o.appendChild(t(i));const d=a?a.displayName:n.type?"نوع مخصص غير معروف":'<span style="color: var(--warning-color);">بيانات غير متوفرة</span>',l=t("");l.innerHTML=d,o.appendChild(l);let c=(n.desc||"").replace(/⭐\s*/g,"")||'<span style="color: var(--warning-color);">بيانات غير متوفرة</span>';n.recurringTemplateId&&(c='<span class="recurring-indicator" title="مصروف متكرر">⭐ </span>'+c);const u=t("");u.innerHTML=c,o.appendChild(u);const p=Object.keys(n.details||{}).length>0?function(t){const n=e.expenseTypes.find(e=>e.id===t.type);if(n&&n.fields&&n.fields.length>0)return n.fields.map(e=>{const n=t.details[e.name];return null==n?null:`${e.label}: ${n}`}).filter(Boolean).join("، ");if(t.details&&Object.keys(t.details).length>0)return Object.values(t.details).join("، ");return""}(n):'<span style="color: var(--warning-color);">بيانات غير متوفرة</span>',m=t("");m.innerHTML=p,o.appendChild(m),o.appendChild(t(`${n.total.toFixed(2)} د.ت`));const g=document.createElement("td");let y="بالتساوي";"percentage"===n.splitMethod?y=`نسبة (${n.splitDetails.you}% / ${n.splitDetails.partner}%)`:"fixed"===n.splitMethod&&(y=`محدد (${n.splitDetails.you.toFixed(2)} / ${n.splitDetails.partner.toFixed(2)})`),g.textContent=y,o.appendChild(g),o.appendChild(t("you"===n.payer?"أنت":"شريكك")),o.appendChild(t(function(e){const t=new Date(e);return isNaN(t.getTime())||!e?"تاريخ غير معروف":t.toLocaleDateString("ar-EG",{year:"numeric",month:"long",day:"numeric"})}(n.date)));const f=document.createElement("td");return f.innerHTML=`<div class="action-buttons"><button class="edit-btn" data-id="${n.id}">تعديل</button><button class="delete-btn" data-id="${n.id}">حذف</button></div>`,o.appendChild(f),o},r=async e=>{const t=document.createDocumentFragment();for(const r of e){const e=n(r.expense,r.index);t.appendChild(e)}l.appendChild(t),await new Promise(e=>setTimeout(e,0))},o=i.map((e,t)=>({expense:e,index:t})),a=3;for(let e=0;e<o.length;e+=a){const t=o.slice(e,e+a);await r(t)}}n=!1,r&&(r=!1,ue())}(t),function(){let t=0,n=0,r=0,o=0;e.expenses.forEach(e=>{"you"===e.payer?t+=e.total:n+=e.total;let s=0,a=0;switch(e.splitMethod){case"percentage":s=e.total*(e.splitDetails.you/100),a=e.total*(e.splitDetails.partner/100);break;case"fixed":s=e.splitDetails.you,a=e.splitDetails.partner;break;default:s=e.total/2,a=e.total/2}r+=s,o+=a});const s=t+n,a=t-r;let i="التسوية تمت، لا أحد مدين للآخر.";a>0?i=`يجب أن يدفع شريكك لك ${a.toFixed(2)} د.ت`:a<0&&(i=`يجب أن تدفع لشريكك ${Math.abs(a).toFixed(2)} د.ت`);const d=Math.abs(a);u.textContent=`${t.toFixed(2)} د.ت`,p.textContent=`${n.toFixed(2)} د.ت`,m.textContent=`${d.toFixed(2)} د.ت`,g.textContent=`${s.toFixed(2)} د.ت`,c.innerHTML=`\n            <div class="total-item">👤 إجمالي ما دفعته أنت: <strong>${t.toFixed(2)} د.ت</strong></div>\n            <div class="total-item">🧾 حصتك الفعلية من المصروفات: <strong>${r.toFixed(2)} د.ت</strong></div>\n            <hr>\n            <div class="total-item">👥 إجمالي ما دفعه شريكك: <strong>${n.toFixed(2)} د.ت</strong></div>\n            <div class="total-item">🧾 حصته الفعلية من المصروفات: <strong>${o.toFixed(2)} د.ت</strong></div>\n            <hr>\n            <div class="total-item">📊 إجمالي المصروفات: <strong>${s.toFixed(2)} د.ت</strong></div>\n            <div class="difference">⚖️ ${i}</div>`}(),function(){L.innerHTML="";const t=e.budgets.filter(e=>me.getCurrentPeriodId(e.periodType)===e.periodId);if(0===t.length)return void(L.innerHTML='<p class="placeholder-text">لا توجد ميزانيات نشطة للفترة الحالية.</p>');t.forEach(t=>{const n=e.expenseTypes.find(e=>e.id===t.categoryId);if(!n)return;const r=me.getDateRangeFromPeriodId(t.periodId),o=e.expenses.filter(e=>e.type===t.categoryId&&e.date>=r.start&&e.date<=r.end).reduce((e,t)=>e+t.total,0),s=t.amount>0?o/t.amount*100:0,a=t.amount-o;let i="low";s>90?i="high":s>70&&(i="medium");const d=document.createElement("div");d.className="budget-item",d.innerHTML=`\n                <div class="budget-item-header">\n                    <span class="budget-item-category">${n.displayName} (${me.periodTypeToText[t.periodType]})</span>\n                    <span class="budget-item-amount">${o.toFixed(2)} / ${t.amount.toFixed(2)} د.ت</span>\n                </div>\n                <div class="progress-bar-container">\n                    <div class="progress-bar-fill ${i}" style="width: ${Math.min(s,100)}%;"></div>\n                </div>\n                <div class="budget-item-footer ${a<0?"over-budget":""}">\n                    ${a>=0?`المتبقي: ${a.toFixed(2)} د.ت`:`تجاوز الحد بـ: ${Math.abs(a).toFixed(2)} د.ت`}\n                </div>`,L.appendChild(d)})}(),function(t){const n=Math.ceil(t.length/o);C.textContent=`صفحة ${e.currentPage} من ${n>0?n:1}`,B.disabled=1===e.currentPage,D.disabled=e.currentPage===n||0===n}(t)}const pe=indexedDB.open("SharedExpensesDB",7);pe.onerror=function(){console.error("فشل فتح قاعدة بيانات IndexedDB"),ge("❌ حدث خطأ كبير في قاعدة البيانات!","error")},pe.onsuccess=function(e){t=e.target.result,setTimeout(ve,0)},pe.onupgradeneeded=function(e){if(t=e.target.result,!t.objectStoreNames.contains("expenses")){t.createObjectStore("expenses",{keyPath:"id"}).createIndex("type","type",{unique:!1})}if(t.objectStoreNames.contains("expenseTypes")||t.createObjectStore("expenseTypes",{keyPath:"id"}),!t.objectStoreNames.contains("budgets")){t.createObjectStore("budgets",{keyPath:"budgetId"}).createIndex("periodId","periodId",{unique:!1})}t.objectStoreNames.contains("recurringExpenses")||t.createObjectStore("recurringExpenses",{keyPath:"id"})};const me={getWeekNumber:function(e){(e=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate()))).setUTCDate(e.getUTCDate()+4-(e.getUTCDay()||7));const t=new Date(Date.UTC(e.getUTCFullYear(),0,1));return Math.ceil(((e-t)/864e5+1)/7)},getCurrentPeriodId:function(e,t=new Date){const n=t.getFullYear();switch(e){case"weekly":return`${n}-W${this.getWeekNumber(t).toString().padStart(2,"0")}`;case"monthly":return`${n}-${(t.getMonth()+1).toString().padStart(2,"0")}`;case"quarterly":return`${n}-Q${Math.floor(t.getMonth()/3)+1}`;case"semi-annually":return`${n}-H${t.getMonth()<6?1:2}`;case"annually":return`${n}`;default:return null}},getDateRangeFromPeriodId:function(e){const[t,n]=e.split("-"),r=parseInt(t);if(e.includes("-W")){const e=parseInt(n.substring(1)),t=new Date(r,0,1+7*(e-1)),o=t.getDay()||7;t.setDate(t.getDate()+1-o);const s=new Date(t),a=new Date(t);return a.setDate(t.getDate()+6),{start:s.toISOString().slice(0,10),end:a.toISOString().slice(0,10)}}if(e.includes("-Q")){const e=3*(parseInt(n.substring(1))-1),t=new Date(r,e,1),o=new Date(r,e+3,0);return{start:t.toISOString().slice(0,10),end:o.toISOString().slice(0,10)}}if(e.includes("-H")){const e=1===parseInt(n.substring(1))?0:6,t=new Date(r,e,1),o=new Date(r,e+6,0);return{start:t.toISOString().slice(0,10),end:o.toISOString().slice(0,10)}}if(n&&2===n.length){const e=parseInt(n)-1,t=new Date(r,e,1),o=new Date(r,e+1,0);return{start:t.toISOString().slice(0,10),end:o.toISOString().slice(0,10)}}return{start:`${r}-01-01`,end:`${r}-12-31`}},periodTypeToText:{weekly:"أسبوعي",monthly:"شهري",quarterly:"ربع سنوي","semi-annually":"نصف سنوي",annually:"سنوي"}};function ge(e,t="info",n=5e3){const r=document.createElement("div");r.className=`alert alert-${t}`,r.textContent=e,r.setAttribute("role","alert"),r.style.cssText=`\n            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);\n            padding: 16px 32px; border-radius: var(--border-radius);\n            background-color: ${"success"===t?"var(--success-color)":"var(--danger-color)"};\n            color: var(--text-white); z-index: 2000; box-shadow: var(--box-shadow-lg);\n            opacity: 0; transition: opacity 0.3s, top 0.3s;\n        `,document.body.appendChild(r),setTimeout(()=>{r.style.opacity="1",r.style.top="40px"},10),setTimeout(()=>{r.style.opacity="0",r.style.top="20px",setTimeout(()=>r.remove(),300)},n)}function ye(e){return`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")}`}function fe(t){const n=e.expenseTypes.find(e=>e.id===t);if(i.innerHTML="",n&&n.fields.length>0){const e=document.createElement("div");e.className="expense-type-fields",n.fields.forEach(t=>{const n=document.createElement("div");n.className="field-group";const r=document.createElement("label");r.htmlFor=t.name,r.textContent=t.label;const o=document.createElement("input");o.type="number",o.id=t.name,o.name=t.name,o.min="0",o.step="0.01",o.value="0.00",o.required=!0,n.appendChild(r),n.appendChild(o),e.appendChild(n)}),i.appendChild(e),e.addEventListener("input",()=>be())}else i.innerHTML="<p>اختر نوع المصروف لظهور الحقول المناسبة</p>";be()}function be(t=!1){let n=0;const r={},o=a.value,s=e.expenseTypes.find(e=>e.id===o);if(s&&s.fields.length>0){let e=0;s.fields.forEach((t,n)=>{const o=document.getElementById(t.name),a=parseFloat(o?.value)||0;if(r[t.name]=a,0===n)e=a;else{switch(s.fields[n-1].operator){case"+":default:e+=a;break;case"-":e-=a;break;case"*":e*=a;break;case"/":0!==a?e/=a:e=1/0}}}),n=e}if(isFinite(n)?(d.textContent=`الإجمالي: ${n.toFixed(2)} د.ت`,d.style.color="var(--success-color)"):(n=0,d.textContent="الإجمالي: خطأ في المعادلة",d.style.color="var(--danger-color)"),t)return{total:n,details:r}}async function ve(){t&&(await xe(),0===e.expenseTypes.length&&(await new Promise(e=>{const n=[{id:"food",displayName:"مواد غذائية",fields:[{name:"weight",label:"الوزن (كجم)",operator:"*"},{name:"pricePerKilo",label:"سعر الكيلو",operator:"+"},{name:"load",label:"الحمولة",operator:"+"}]},{id:"advertising",displayName:"دعاية وإعلان",fields:[{name:"meters",label:"عدد الأمتار",operator:"*"},{name:"pricePerMeter",label:"سعر المتر",operator:"+"}]},{id:"equipment",displayName:"معدات وأدوات",fields:[{name:"quantity",label:"العدد",operator:"*"},{name:"unitPrice",label:"سعر الوحدة",operator:"+"}]},{id:"operational",displayName:"تشغيلية",fields:[{name:"price",label:"السعر",operator:"+"}]},{id:"misc",displayName:"نثرية",fields:[{name:"price",label:"السعر",operator:"+"}]}],r=t.transaction(["expenseTypes"],"readwrite"),o=r.objectStore("expenseTypes");n.forEach(e=>o.add(e)),r.oncomplete=e}),await xe()),await Ee(),await new Promise(n=>{const r=t.transaction(["recurringExpenses"],"readonly").objectStore("recurringExpenses").getAll();r.onsuccess=()=>{e.recurringExpenses=r.result,n()},r.onerror=()=>{ge("❌ فشلت قراءة المصروفات المتكررة.","error"),n()}}),await async function(){return 0===e.recurringExpenses.length?Promise.resolve():new Promise(n=>{const r=new Date;r.setHours(0,0,0,0);let o=0,s=[];const a=t.transaction(["expenses","recurringExpenses"],"readwrite"),i=a.objectStore("recurringExpenses"),d=a.objectStore("expenses"),l=i.getAll();l.onsuccess=()=>{l.result.forEach(e=>{let t=new Date(e.nextDueDate+"T00:00:00");for(;t<=r;){const n={...e.baseExpenseData,id:Date.now()+Math.random(),date:ye(t),recurringTemplateId:e.id};d.add(n),s.push(n),o++;const r=Te(ye(t),e.frequency);e.nextDueDate=r,t=new Date(r+"T00:00:00")}i.put(e)})},a.oncomplete=()=>{o>0&&(ce({expenses:[...e.expenses,...s]}),ge(`✔ تم إنشاء ${o} مصروف متكرر فائت تلقائيًا.`,"success")),n()},a.onerror=()=>{ge("❌ حدث خطأ أثناء إنشاء المصروفات المتكررة.","error"),n()}})}(),await he(),we(a),we(E,!0),ue())}function xe(){return new Promise(e=>{const n=t.transaction(["expenseTypes"],"readonly").objectStore("expenseTypes").getAll();n.onsuccess=()=>{ce({expenseTypes:n.result}),e()},n.onerror=()=>{ge("❌ فشلت قراءة أنواع المصروفات.","error"),e()}})}function he(){return new Promise(e=>{const n=t.transaction(["expenses"],"readonly").objectStore("expenses").getAll();n.onsuccess=()=>{ce({expenses:n.result}),e()},n.onerror=()=>{ge("❌ فشلت قراءة المصروفات.","error"),e()}})}function Ee(){return new Promise(e=>{const n=t.transaction(["budgets"],"readonly").objectStore("budgets").getAll();n.onsuccess=()=>{ce({budgets:n.result}),e()},n.onerror=()=>{ge("❌ فشلت قراءة الميزانيات.","error"),e()}})}function Ie(){let t=[...e.expenses];const{search:n,type:r,startDate:o,endDate:s}=e.filters;return n&&(t=t.filter(e=>e.desc.toLowerCase().includes(n.toLowerCase()))),"all"!==r&&(t=t.filter(e=>e.type===r)),o&&(t=t.filter(e=>e.date>=o)),s&&(t=t.filter(e=>e.date<=s)),t.sort((e,t)=>new Date(t.date)-new Date(e.date))}function we(t,n=!1){const r=t.value;if(t.innerHTML="",n){const e=document.createElement("option");e.value="all",e.textContent="كل الأنواع",t.appendChild(e)}else{const e=document.createElement("option");e.value="",e.textContent="اختر نوع المصروف",t.appendChild(e)}e.expenseTypes.forEach(e=>{const n=document.createElement("option");n.value=e.id,n.textContent=e.displayName,t.appendChild(n)}),t.value=r}function Te(e,t){const n=new Date(e);switch(t){case"weekly":n.setDate(n.getDate()+7);break;case"monthly":n.setMonth(n.getMonth()+1);break;case"annually":n.setFullYear(n.getFullYear()+1)}return ye(n)}function Se(e){if(!t)return;const n=t.transaction(["expenses"],"readwrite");n.objectStore("expenses").delete(e),n.oncomplete=()=>{he().then(()=>ge("تم حذف المصروف.","success"))},n.onerror=()=>ge("❌ فشلت عملية الحذف.","error")}function $e(){s.reset(),f.value=(new Date).toISOString().split("T")[0],W.parentElement.style.display="flex",W.dispatchEvent(new Event("change")),fe(""),e.editMode&&ce({editMode:!1,currentEditId:null}),v.textContent="إضافة المصروف",v.style.width="100%",x.style.display="none",N.value="equal",N.dispatchEvent(new Event("change")),P.value=50,A.value=50,_.value="",U.value=""}function Be(){K.innerHTML="",e.expenseTypes.forEach(e=>{const t=document.createElement("div");t.className="type-editor-item",t.dataset.typeId=e.id;let n=e.fields.map((e,t)=>`<div class="field-editor-row" data-field-index="${t}"><div><label>اسم الحقل</label><input type="text" value="${e.label}" class="field-name-input" placeholder="مثال: السعر"></div><div><label>العملية الحسابية</label><div class="operator-selector"><button data-op="+" class="${"+"===e.operator?"active":""}">+</button><button data-op="*" class="${"*"===e.operator?"active":""}">*</button><button data-op="-" class="${"-"===e.operator?"active":""}">-</button><button data-op="/" class="${"/"===e.operator?"active":""}">/</button></div></div><button class="btn btn-reset delete-field-btn" aria-label="حذف الحقل">&times;</button></div>`).join("");t.innerHTML=`<div class="type-editor-header"><input type="text" value="${e.displayName}" class="type-name-input" placeholder="اسم نوع المصروف"><div class="type-editor-actions"><button class="btn btn-add save-type-btn">حفظ</button><button class="btn btn-reset delete-type-btn">حذف</button></div></div><div class="field-editor-list">${n}</div><button class="btn add-field-btn">+ إضافة حقل</button><div class="formula-preview">${function(e){let t="";e.fields&&e.fields.forEach((n,r)=>{const o=n.label.trim()||`حقل ${r+1}`;if(0===r)t=`(${o})`;else{const n=e.fields[r-1].operator||"+";t=`(${t} ${n} ${o})`}});return`<span>الإجمالي = </span>${t||"لا توجد حقول"}`}(e)}</div>`,K.appendChild(t)}),K.querySelectorAll(".type-editor-item").forEach(n=>{const r=n.dataset.typeId;n.querySelector(".save-type-btn").addEventListener("click",()=>function(n){const r=document.querySelector(`.type-editor-item[data-type-id="${n}"]`),o=e.expenseTypes.findIndex(e=>e.id==n);if(-1===o)return;const s=r.querySelector(".type-name-input").value.trim();if(!s)return void ge("❌ اسم النوع لا يمكن أن يكون فارغاً.","error");const i=[];r.querySelectorAll(".field-editor-row").forEach((t,n)=>{const r=t.querySelector(".field-name-input").value.trim(),s=t.querySelector(".operator-selector .active");i.push({name:e.expenseTypes[o].fields[n]?.name||`field_${Date.now()}_${n}`,label:r||`حقل ${n+1}`,operator:s?s.dataset.op:"+"})});const d={...e.expenseTypes[o],displayName:s,fields:i},l=t.transaction(["expenseTypes"],"readwrite");l.objectStore("expenseTypes").put(d),l.oncomplete=()=>{xe().then(()=>{ge("✔ تم حفظ التغييرات بنجاح!","success"),Be(),we(a),we(E,!0)})}}(r)),n.querySelector(".delete-type-btn").addEventListener("click",()=>async function(e){const n=await function(e){return new Promise(n=>{const r=new Promise(n=>{const r=t.transaction(["expenses"],"readonly").objectStore("expenses").index("type").count(e);r.onsuccess=()=>n(r.result>0),r.onerror=()=>n(!0)}),o=new Promise(n=>{const r=t.transaction(["budgets"],"readonly").objectStore("budgets").getAll();r.onsuccess=()=>{const t=r.result.some(t=>t.categoryId===e);n(t)},r.onerror=()=>n(!0)}),s=new Promise(n=>{const r=t.transaction(["recurringExpenses"],"readonly").objectStore("recurringExpenses").getAll();r.onsuccess=()=>{const t=r.result.some(t=>t.baseExpenseData.type===e);n(t)},r.onerror=()=>n(!0)});Promise.all([r,o,s]).then(e=>{const[t,r,o]=e;n(t||r||o)})})}(e);if(n)ge("❌ لا يمكن حذف هذا النوع لوجود مصروفات مسجلة مرتبطة به.","error");else if(confirm("هل أنت متأكد من حذف هذا النوع؟")){const n=t.transaction(["expenseTypes"],"readwrite");n.objectStore("expenseTypes").delete(e),n.onerror=()=>ge("❌ فشلت عملية حذف النوع.","error"),n.oncomplete=()=>{xe().then(()=>{ge("تم الحذف بنجاح.","success"),Be(),we(a),we(E,!0)})}}}(r)),n.querySelector(".add-field-btn").addEventListener("click",()=>function(t){const n=e.expenseTypes.findIndex(e=>e.id==t);if(-1===n)return;const r=document.querySelector(`.type-editor-item[data-type-id="${t}"]`);if(!r)return;const o=r.querySelector(".type-name-input").value.trim();e.expenseTypes[n].displayName=o||"نوع جديد";const s=[];r.querySelectorAll(".field-editor-row").forEach((t,r)=>{const o=t.querySelector(".field-name-input").value.trim(),a=t.querySelector(".operator-selector .active"),i=a?a.dataset.op:"+",d=e.expenseTypes[n].fields[r]?.name||`field_${Date.now()}_${r}`;s.push({name:d,label:o||`حقل ${r+1}`,operator:i})}),e.expenseTypes[n].fields=s,e.expenseTypes[n].fields.push({name:`field_${Date.now()}`,label:"",operator:"+"}),Be()}(r)),n.querySelectorAll(".delete-field-btn").forEach(t=>{t.addEventListener("click",t=>{const n=parseInt(t.target.closest(".field-editor-row").dataset.fieldIndex);!function(t,n){const r=e.expenseTypes.findIndex(e=>e.id==t);r>-1&&(e.expenseTypes[r].fields.splice(n,1),Be())}(r,n)})}),n.querySelectorAll(".operator-selector button").forEach(e=>{e.addEventListener("click",e=>{const t=e.target.parentElement;t.querySelector(".active")?.classList.remove("active"),e.target.classList.add("active")})})})}function De(){Z.innerHTML="";const n=document.createElement("div");n.className="budget-settings-list";const r=e.expenseTypes.filter(t=>e.budgets.some(e=>e.categoryId===t.id));0===r.length?n.innerHTML="<p class=\"placeholder-text\">لا توجد ميزانيات. اضغط على 'إضافة' للبدء.</p>":r.forEach(t=>{const r=e.budgets.find(e=>e.categoryId===t.id),o=Object.keys(me.periodTypeToText).map(e=>`<option value="${e}" ${r.periodType===e?"selected":""}>${me.periodTypeToText[e]}</option>`).join(""),s=document.createElement("div");s.className="budget-setting-item",s.innerHTML=`\n                    <span class="budget-setting-name">${t.displayName}</span>\n                    <div class="budget-controls">\n                        <div class="budget-input-group">\n                            <input type="number" class="budget-input" data-category-id="${t.id}" value="${r.amount}" min="0" step="0.01">\n                            <span>د.ت</span>\n                        </div>\n                        <select class="budget-period-select">${o}</select>\n                    </div>\n                    <button class="budget-item-delete-btn" data-budget-id="${r.budgetId}">&times;</button>\n                `,n.appendChild(s)}),Z.appendChild(n),Z.querySelectorAll(".budget-item-delete-btn").forEach(e=>{e.addEventListener("click",()=>function(e){if(!confirm("هل أنت متأكد من حذف هذه الميزانية؟"))return;const n=t.transaction(["budgets"],"readwrite");n.objectStore("budgets").delete(e),n.onerror=()=>ge("❌ فشلت عملية حذف الميزانية.","error"),n.oncomplete=()=>{Ee().then(()=>De()),ge("تم حذف الميزانية.","success")}}(e.dataset.budgetId))})}function Ce(){if(0===e.budgets.length)return void ge("ℹ️ لا توجد ميزانيات لحذفها.","info");if(confirm("هل أنت متأكد من رغبتك في مسح جميع الميزانيات؟ لا يمكن التراجع عن هذا الإجراء.")){if(!t)return;const e=t.transaction(["budgets"],"readwrite");e.objectStore("budgets").clear(),e.oncomplete=()=>{ce({budgets:[]}),ge("تم مسح جميع الميزانيات بنجاح.","success")},e.onerror=()=>ge("❌ فشلت عملية مسح الميزانيات.","error")}}function Le(){const t=re.element.querySelector("#recurringListContainer");t.innerHTML="",0!==e.recurringExpenses.length?e.recurringExpenses.forEach(e=>{const n=document.createElement("div");n.className="recurring-item";const r=document.createElement("div");r.className="recurring-item-details";const o=document.createElement("span");o.className="recurring-item-desc",o.textContent=e.baseExpenseData.desc;const s=document.createElement("span");s.className="recurring-item-info",s.innerHTML=`<strong>${e.baseExpenseData.total.toFixed(2)} د.ت</strong> - ${me.periodTypeToText[e.frequency]}`,r.appendChild(o),r.appendChild(s);const a=document.createElement("div");a.className="recurring-item-actions";const i=document.createElement("button");i.className="btn btn-reset",i.textContent="حذف",i.onclick=()=>ke(e.id),a.appendChild(i),n.appendChild(r),n.appendChild(a),t.appendChild(n)}):t.innerHTML='<p class="placeholder-text">لا توجد مصروفات متكررة محفوظة.</p>'}function ke(n){const r=t.transaction(["recurringExpenses"],"readwrite");r.objectStore("recurringExpenses").delete(n),r.oncomplete=()=>{e.recurringExpenses=e.recurringExpenses.filter(e=>e.id!==n),ge("✔ تم حذف المصروف المتكرر.","success"),Le()},r.onerror=()=>ge("❌ فشلت عملية الحذف.","error")}function Me(){if(!t)return;const e=t.transaction(["expenses"],"readwrite");e.objectStore("expenses").clear(),e.oncomplete=()=>{ce({expenses:[],currentPage:1}),ge("تم مسح جميع المصروفات بنجاح.","success")},e.onerror=()=>{ge("❌ فشلت عملية مسح المصروفات.","error")}}s.addEventListener("submit",function(n){if(n.preventDefault(),!document.getElementById("desc").value.trim())return void ge("❌ يرجى إدخال وصف للمصروف (اسم المنتج / الخدمة).","error");const r=new Date;if(r.setHours(0,0,0,0),new Date(f.value+"T00:00:00")>r&&!W.checked&&!confirm("التاريخ الذي أدخلته هو في المستقبل. هل أنت متأكد من رغبتك في الإضافة؟"))return;const o=a.value;if(!e.expenseTypes.find(e=>e.id===o))return void ge("❌ يرجى اختيار نوع مصروف صالح.","error");const s=be(!0);if(s.total<0)ge("❌ لا يمكن إضافة مصروف بقيمة سالبة.","error");else{if("fixed"===N.value){const e=parseFloat(_.value)||0,t=parseFloat(U.value)||0;if(Math.abs(e+t-s.total)>.01)return void ge("❌ خطأ: مجموع الحصص المحددة لا يساوي الإجمالي الكلي للفاتورة. يرجى تعديل الحصص.","error")}s.total<=0&&!W.checked?ge("❌ الإجمالي يجب أن يكون أكبر من الصفر.","error"):W.checked?function(n){const r=N.value;let o={};"percentage"===r?o={you:parseFloat(P.value),partner:parseFloat(A.value)}:"fixed"===r&&(o={you:parseFloat(_.value),partner:parseFloat(U.value)});const s={type:a.value,desc:document.getElementById("desc").value.trim(),payer:document.getElementById("payer").value,total:n.total,details:n.details,splitMethod:r,splitDetails:o},i={id:`rec_${Date.now()}`,frequency:Y.value,nextDueDate:f.value,baseExpenseData:s},d=t.transaction(["recurringExpenses"],"readwrite"),l=d.objectStore("recurringExpenses").add(i);l.onsuccess=()=>{e.recurringExpenses.push(i),ge("✔ تم حفظ المصروف المتكرر بنجاح!","success"),$e()},l.onerror=()=>ge("❌ فشلت عملية حفظ المصروف المتكرر.","error")}(s):function(n){const r=N.value;let o={};"percentage"===r?o={you:parseFloat(P.value),partner:parseFloat(A.value)}:"fixed"===r&&(o={you:parseFloat(_.value),partner:parseFloat(U.value)});const s={id:e.editMode?e.currentEditId:Date.now(),type:a.value,desc:document.getElementById("desc").value.trim(),payer:document.getElementById("payer").value,date:f.value,total:n.total,details:n.details,splitMethod:r,splitDetails:o},i=t.transaction(["expenses"],"readwrite").objectStore("expenses"),d=e.editMode?i.put(s):i.add(s);d.onsuccess=()=>{he().then(()=>{ge(`✔ ${e.editMode?"تم حفظ التعديلات":"تم إضافة المصروف"}!`,"success"),ce({editMode:!1,currentEditId:null}),$e()})},d.onerror=()=>ge(`❌ فشلت عملية ${e.editMode?"حفظ التعديلات":"إضافة المصروف"}.`,"error")}(s)}}),x.addEventListener("click",$e),a.addEventListener("change",()=>fe(a.value)),y.addEventListener("click",t=>{0!==e.expenses.length?ie.open(t.currentTarget):ge("ℹ️ لا توجد بيانات لمسحها.","info")}),de.addEventListener("click",()=>{Me(),ie.close()}),le.addEventListener("click",()=>{Me(),function(){if(!t)return;const n=t.transaction(["recurringExpenses"],"readwrite");n.objectStore("recurringExpenses").clear(),n.oncomplete=()=>{e.recurringExpenses=[],ge("تم مسح قوالب المصروفات المتكررة.","success"),Le()},n.onerror=()=>ge("❌ فشلت عملية مسح القوالب المتكررة.","error")}(),Ce(),ie.close()}),b.addEventListener("click",function(){if(0===e.expenses.length)return void ge("ℹ️ لا توجد بيانات لتصديرها.","info");const t=`#TYPES_DEFINITION#${JSON.stringify(e.expenseTypes)}`,n=e.expenses.map(e=>{const t=e=>`"${String(e).replace(/"/g,'""')}"`;return[e.id,e.type,t(e.desc),e.payer,e.total,e.date,t(JSON.stringify(e.details||{})),t(e.splitMethod||"equal"),t(JSON.stringify(e.splitDetails||{})),t(e.recurringTemplateId||"")].join(",")}),r=[t,["id","type","desc","payer","total","date","details_json","splitMethod","splitDetails_json","recurringTemplateId"].join(","),...n].join("\n"),o=new Uint8Array([239,187,191]),s=new Blob([o,r],{type:"text/csv;charset=utf-8;"}),a=document.createElement("a");a.href=URL.createObjectURL(s),a.download=`مصروفاتي_${(new Date).toISOString().slice(0,10)}.csv`,document.body.appendChild(a),a.click(),document.body.removeChild(a)}),S.addEventListener("click",()=>$.click()),$.addEventListener("change",async function(n){const r=n.target.files[0];if(!r)return;const o=new FileReader;o.onload=async function(n){let r=n.target.result,o=null;if(r.startsWith("#TYPES_DEFINITION#")){const e=r.split("\n"),t=e.shift().substring(18);try{o=JSON.parse(t)}catch(e){return void ge("❌ فشل تحليل تعريفات الأنواع في ملف الاستيراد.","error")}r=e.join("\n")}try{const n=function(e){const t=e=>{const t=[];let n="",r=!1;for(let o=0;o<e.length;o++){const s=e[o];'"'===s?r&&'"'===e[o+1]?(n+='"',o++):r=!r:","!==s||r?n+=s:(t.push(n),n="")}return t.push(n),t},n=e.trim().split("\n"),r=n.shift();if(!r)return ge("❌ ملف CSV فارغ أو غير صالح.","error"),null;const o=r.split(",").map(e=>e.trim().replace(/"/g,"")),s=["id","total","payer","date"];for(const e of s)if(!o.includes(e))return ge(`❌ ملف CSV غير صالح. العمود الحيوي "${e}" غير موجود.`,"error"),null;const a=o.indexOf("id"),i=o.indexOf("type"),d=o.indexOf("desc"),l=o.indexOf("payer"),c=o.indexOf("total"),u=o.indexOf("date"),p=o.indexOf("details_json"),m=o.indexOf("splitDetails_json"),g=o.indexOf("splitMethod"),y=o.indexOf("recurringTemplateId");let f=0;const b=n.map(e=>{if(!e.trim())return null;const n=t(e),r=e=>(n[e]||"").trim();try{const e=Number(r(a)),t=parseFloat(r(c)),n=r(l),o=r(u);return!isNaN(e)&&isFinite(t)&&n&&o?{id:e,total:t,payer:n,date:o,type:r(i),desc:r(d),details:JSON.parse(r(p)||"{}"),splitDetails:JSON.parse(r(m)||"{}"),splitMethod:r(g)||"equal",recurringTemplateId:r(y)||null}:(f++,null)}catch(t){return console.error("Error parsing line:",e,t),f++,null}}).filter(Boolean);f>0&&ge(`⚠️ تم تجاهل ${f} صفوف لعدم اكتمال بياناتها الحيوية.`,"warning");return b}(r);if(n){const r="هل أنت متأكد؟ سيتم حذف جميع البيانات الحالية (المصروفات والأنواع) واستبدالها بالبيانات من الملف.";(0===e.expenses.length||confirm(r))&&(o&&await(s=o,new Promise((e,n)=>{if(!t||!s||0===s.length)return e();const r=t.transaction(["expenseTypes"],"readwrite"),o=r.objectStore("expenseTypes");o.clear(),s.forEach(e=>{o.add(e)}),r.oncomplete=()=>{console.log("تم استبدال أنواع المصروفات بنجاح."),e()},r.onerror=e=>{console.error("فشلت عملية استبدال أنواع المصروفات.",e.target.error),ge("❌ فشلت عملية استيراد الأنواع.","error"),n()}})),await xe(),function(e){const n=t.transaction(["expenses"],"readwrite"),r=n.objectStore("expenses");r.clear(),e.forEach(e=>{r.add(e)}),n.oncomplete=()=>{he().then(()=>{ge("✔ تم استيراد بيانات المصروفات بنجاح!","success")})},n.onerror=()=>{ge("❌ فشلت عملية استبدال بيانات المصروفات.","error")}}(n))}}catch(e){console.error("Error during import:",e),ge("❌ فشل تحليل ملف المصروفات.","error")}var s},o.readAsText(r),n.target.value=""}),l.addEventListener("click",t=>{const n=t.target;if("BUTTON"!==n.tagName)return;const r=Number(n.dataset.id),o=e.expenses.find(e=>e.id===r);o&&(n.classList.contains("delete-btn")?o.hasOwnProperty("recurringTemplateId")?(oe.element.dataset.expenseId=r,oe.element.dataset.templateId=o.recurringTemplateId,oe.open(t.target)):confirm(`هل أنت متأكد من حذف هذا المصروف: "${o.desc}"؟`)&&Se(r):n.classList.contains("edit-btn")&&function(t){const n=e.expenses.find(e=>e.id===t);if(!n)return;ce({editMode:!0,currentEditId:t}),document.getElementById("desc").value=n.desc,f.value=n.date,a.value=n.type,document.getElementById("payer").value=n.payer,fe(n.type),setTimeout(()=>{const e=n.details;for(const t in e){const n=document.getElementById(t);n&&(n.value=e[t])}be()},0),v.textContent="حفظ التعديلات",v.style.width="auto",x.style.display="inline-flex",W.checked=!1,W.dispatchEvent(new Event("change"));const r=n.splitMethod||"equal";N.value=r,N.dispatchEvent(new Event("change")),"percentage"===r?(P.value=n.splitDetails.you,A.value=n.splitDetails.partner):"fixed"===r&&(_.value=n.splitDetails.you,U.value=n.splitDetails.partner),window.scrollTo({top:0,behavior:"smooth"})}(r))}),se.addEventListener("click",()=>{Se(Number(oe.element.dataset.expenseId)),oe.close()}),ae.addEventListener("click",()=>{const e=Number(oe.element.dataset.expenseId),t=oe.element.dataset.templateId;Se(e),ke(t),oe.close()}),h.addEventListener("input",t=>ce({filters:{...e.filters,search:t.target.value},currentPage:1})),E.addEventListener("change",t=>ce({filters:{...e.filters,type:t.target.value},currentPage:1})),I.addEventListener("change",t=>ce({filters:{...e.filters,startDate:t.target.value},currentPage:1})),w.addEventListener("change",t=>ce({filters:{...e.filters,endDate:t.target.value},currentPage:1})),T.addEventListener("click",()=>{h.value="",E.value="all",I.value="",w.value="",ce({filters:{search:"",type:"all",startDate:"",endDate:""},currentPage:1})}),B.addEventListener("click",()=>{e.currentPage>1&&ce({currentPage:e.currentPage-1})}),D.addEventListener("click",()=>{const t=Math.ceil(Ie().length/o);e.currentPage<t&&ce({currentPage:e.currentPage+1})}),z.addEventListener("click",e=>{Be(),V.open(e.currentTarget)}),Q.addEventListener("click",function(){const e=`custom_${Date.now()}`,n={id:e,displayName:"نوع جديد (اضغط للحفظ)",fields:[{name:`field_${Date.now()}`,label:"السعر",operator:"+"}]},r=t.transaction(["expenseTypes"],"readwrite");r.objectStore("expenseTypes").add(n),r.onerror=()=>ge("❌ فشلت عملية إضافة نوع جديد.","error"),r.oncomplete=()=>{xe().then(()=>{ge("✔ تم إضافة نوع جديد. قم بتعديله ثم اضغط حفظ.","success"),Be();const t=K.querySelector(`[data-type-id="${e}"]`);t&&t.scrollIntoView({behavior:"smooth",block:"center"})})}}),G.addEventListener("click",e=>{De(),X.open(e.currentTarget)}),ee.addEventListener("click",function(){const e=Z.querySelectorAll(".budget-setting-item"),n=t.transaction(["budgets"],"readwrite"),r=n.objectStore("budgets");r.clear();const o=[];e.forEach(e=>{const t=e.querySelector(".budget-input").dataset.categoryId,n=parseFloat(e.querySelector(".budget-input").value),s=e.querySelector(".budget-period-select").value;if(n>0){const e=me.getCurrentPeriodId(s);if(!e)return;const a={budgetId:`${t}_${e}`,categoryId:t,periodId:e,periodType:s,amount:n};r.put(a),o.push(a)}}),n.oncomplete=()=>{ce({budgets:o}),ge("✔ تم حفظ الميزانيات بنجاح!","success"),X.close()},n.onerror=()=>ge("❌ فشلت عملية حفظ الميزانيات.","error")}),te.addEventListener("click",function(){if(document.getElementById("add-budget-form"))return;const n=e.budgets.map(e=>e.categoryId),r=e.expenseTypes.filter(e=>!n.includes(e.id));if(0===r.length)return void ge("ℹ️ كل الفئات لديها ميزانية بالفعل.","info");const o=document.createElement("div");o.id="add-budget-form",o.className="add-budget-form";const s=r.map(e=>`<option value="${e.id}">${e.displayName}</option>`).join(""),a=Object.keys(me.periodTypeToText).map(e=>`<option value="${e}">${me.periodTypeToText[e]}</option>`).join("");o.innerHTML=`\n            <select id="newBudgetCategorySelect"><option value="">اختر فئة...</option>${s}</select>\n            <div class="add-budget-form-inputs">\n                <input id="newBudgetAmountInput" type="number" placeholder="أدخل المبلغ" min="0" step="0.01">\n                <select id="newBudgetPeriodSelect">${a}</select>\n            </div>\n            <button id="confirmAddBudgetBtn" class="btn btn-add">إضافة</button>\n        `,Z.appendChild(o),document.getElementById("confirmAddBudgetBtn").addEventListener("click",()=>{const e=document.getElementById("newBudgetCategorySelect").value,n=parseFloat(document.getElementById("newBudgetAmountInput").value),r=document.getElementById("newBudgetPeriodSelect").value;if(!(e&&n>0))return void ge("❌ يرجى اختيار فئة وإدخال مبلغ صحيح.","error");const o=me.getCurrentPeriodId(r);if(!o)return void ge("❌ فترة زمنية غير صالحة.","error");const s={budgetId:`${e}_${o}`,categoryId:e,periodId:o,periodType:r,amount:n},a=t.transaction(["budgets"],"readwrite");a.objectStore("budgets").add(s),a.oncomplete=()=>{Ee().then(()=>De()),ge("✔ تم إضافة الميزانية.","success")},a.onerror=()=>ge("❌ فشلت إضافة الميزانية.","error")})}),k.addEventListener("click",Ce),M.addEventListener("click",function(){if(0===e.budgets.length)return void ge("ℹ️ لا توجد ميزانيات لتصديرها.","error");const t=e.budgets.map(e=>[e.budgetId,e.categoryId,e.periodId,e.periodType,e.amount].join(",")),n=[["budgetId","categoryId","periodId","periodType","amount"].join(","),...t].join("\n"),r=new Uint8Array([239,187,191]),o=new Blob([r,n],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a");s.href=URL.createObjectURL(o),s.download=`ميزانياتي_${(new Date).toISOString().slice(0,10)}.csv`,document.body.appendChild(s),s.click(),document.body.removeChild(s)}),F.addEventListener("click",()=>j.click()),j.addEventListener("change",function(n){const r=n.target.files[0];if(!r)return;const o=new FileReader;o.onload=function(n){const r=n.target.result;try{const n=function(e){const t=e.trim().split("\n"),n=t.shift();if(!n)return[];const r=n.split(","),o=["budgetId","categoryId","periodId","periodType","amount"];for(const e of o)if(!r.includes(e))return ge(`❌ ملف الميزانيات غير صالح. العمود المفقود: ${e}`,"error"),null;const s=r.indexOf("budgetId"),a=r.indexOf("categoryId"),i=r.indexOf("periodId"),d=r.indexOf("periodType"),l=r.indexOf("amount");return t.map(e=>{const t=e.split(",");try{const e={budgetId:t[s],categoryId:t[a],periodId:t[i],periodType:t[d],amount:parseFloat(t[l])};return!e.budgetId||isNaN(e.amount)?null:e}catch{return null}}).filter(Boolean)}(r);if(n){const r="هل أنت متأكد؟ سيتم حذف جميع الميزانيات الحالية واستبدالها بالبيانات من الملف.";(0===e.budgets.length||confirm(r))&&function(e){const n=t.transaction(["budgets"],"readwrite"),r=n.objectStore("budgets");r.clear(),e.forEach(e=>{r.add(e)}),n.oncomplete=()=>{Ee().then(()=>{ge("✔ تم استيراد الميزانيات بنجاح!","success")})},n.onerror=()=>{ge("❌ فشلت عملية استبدال الميزانيات في قاعدة البيانات.","error")}}(n)}}catch(e){console.error("Error parsing budgets CSV:",e),ge("❌ فشل تحليل ملف الميزانيات. تأكد من أنه ملف CSV صحيح.","error")}},o.readAsText(r),n.target.value=""}),W.addEventListener("change",()=>{R.style.display=W.checked?"block":"none"}),ne.addEventListener("click",e=>{Le(),re.open(e.currentTarget)}),N.addEventListener("change",e=>{const t=e.target.value;q.classList.toggle("visible","equal"!==t),O.classList.toggle("visible","percentage"===t),H.classList.toggle("visible","fixed"===t)}),P.addEventListener("input",()=>{const e=parseFloat(P.value)||0;e>100&&(P.value=100),e<0&&(P.value=0),A.value=100-P.value}),_.addEventListener("input",()=>{const e=be(!0).total,t=parseFloat(_.value)||0;t>e&&(_.value=e),t<0&&(_.value=0),U.value=(e-t).toFixed(2)}),i.addEventListener("input",()=>{const e=be(!0).total;if("fixed"===N.value){const t=parseFloat(_.value)||0;U.value=(e-t).toFixed(2)}});const Fe=document.getElementById("theme-toggle"),je=document.body,Ne=e=>{je.classList.toggle("dark-mode","dark"===e)};Fe.addEventListener("click",()=>{const e=je.classList.contains("dark-mode")?"light":"dark";localStorage.setItem("theme",e),Ne(e)}),f.value=ye(new Date),fe("");const qe=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");Ne(qe),"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("./sw.js").then(e=>console.log("ServiceWorker registration successful")).catch(e=>console.log("ServiceWorker registration failed: ",e))})});